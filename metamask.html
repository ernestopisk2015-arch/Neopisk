<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neo Pisk â€” Comprar $PISK</title>
<link rel="icon" type="image/jpg" href="asset/IMG-20260126-WA0020.jpg">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow+Condensed:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
<style>
:root{
  --gold:#D4A017;--gold2:#F0C040;--gold3:#FFF3B0;
  --dark:#07090C;--dark2:#0D1117;--dark3:#111820;
  --border:rgba(212,160,23,0.2);--border2:rgba(212,160,23,0.06);
  --text:#E8EDF5;--muted:#7A8A9A;--muted2:#3A4A5A;
  --green:#00E676;--red:#FF3D3D;--orange:#F6851B;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--dark);color:var(--text);font-family:'Barlow Condensed',sans-serif;min-height:100vh;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(212,160,23,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(212,160,23,0.03) 1px,transparent 1px);background-size:48px 48px;pointer-events:none;z-index:0;}
.wrap{position:relative;z-index:1;max-width:440px;margin:0 auto;padding:20px 16px 60px;}

.header{text-align:center;padding:28px 20px 20px;border-bottom:1px solid var(--border);margin-bottom:20px;}
.logo-row{display:flex;justify-content:center;gap:14px;margin-bottom:14px;}
.logo-img{width:60px;height:60px;border-radius:50%;border:2px solid var(--gold);box-shadow:0 0 16px rgba(212,160,23,0.3);object-fit:cover;}
.header-title{font-family:'Bebas Neue';font-size:36px;letter-spacing:4px;background:linear-gradient(180deg,var(--gold3),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1;margin-bottom:4px;}
.header-sub{font-size:10px;letter-spacing:5px;color:var(--muted);font-family:'JetBrains Mono';}

/* STATUS */
.status-bar{padding:10px 14px;border:1px solid var(--border2);background:var(--dark3);margin-bottom:14px;font-family:'JetBrains Mono';font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px;}
.dot{width:8px;height:8px;border-radius:50%;background:var(--muted2);flex-shrink:0;transition:all 0.3s;}
.dot.green{background:var(--green);box-shadow:0 0 8px var(--green);}
.dot.red{background:var(--red);}
.dot.orange{background:var(--orange);animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}

/* BALANCE */
.balance-card{background:var(--dark2);border:1px solid var(--border);padding:20px;margin-bottom:16px;position:relative;overflow:hidden;}
.balance-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--gold),transparent);}
.balance-lbl{font-size:10px;letter-spacing:4px;color:var(--muted);font-family:'JetBrains Mono';margin-bottom:4px;}
.balance-val{font-family:'Bebas Neue';font-size:44px;color:var(--gold2);line-height:1;}
.balance-addr{font-family:'JetBrains Mono';font-size:10px;color:var(--muted);margin-top:6px;word-break:break-all;}

/* CALCULADORA */
.calc-card{background:var(--dark2);border:1px solid var(--border);padding:20px;margin-bottom:14px;position:relative;overflow:hidden;}
.calc-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--gold),transparent);}
.input-lbl{font-size:10px;letter-spacing:3px;color:var(--muted);font-family:'JetBrains Mono';margin-bottom:6px;}
.input-field{width:100%;background:var(--dark3);border:1px solid var(--border);color:var(--text);padding:16px;font-family:'JetBrains Mono';font-size:24px;text-align:center;outline:none;transition:border-color 0.2s;margin-bottom:6px;}
.input-field:focus{border-color:var(--gold);}
.input-field::placeholder{color:var(--muted2);}
.calc-result{background:var(--dark3);border:1px solid var(--border);padding:12px;text-align:center;margin-bottom:4px;}
.calc-result-lbl{font-size:10px;letter-spacing:3px;color:var(--muted);font-family:'JetBrains Mono';margin-bottom:2px;}
.calc-result-val{font-family:'Bebas Neue';font-size:36px;color:var(--gold2);}
.calc-debug{font-size:10px;color:var(--muted2);font-family:'JetBrains Mono';text-align:center;margin-top:4px;}

/* BUTTONS */
.btn{width:100%;padding:16px;border:none;cursor:pointer;font-family:'Bebas Neue';font-size:20px;letter-spacing:3px;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:10px;}
.btn:active{transform:scale(0.97);}
.btn:disabled{opacity:0.35;cursor:not-allowed;}
.btn-connect{background:var(--dark2);border:1px solid var(--border);color:var(--gold2);}
.btn-approve{background:var(--dark2);border:1px solid var(--border);color:var(--text);}
.btn-buy{background:linear-gradient(135deg,var(--gold),#8B6914);color:var(--dark);font-size:22px;box-shadow:0 0 24px rgba(212,160,23,0.2);}
.btn-buy:hover{box-shadow:0 0 40px rgba(212,160,23,0.4);}

.section-tag{font-family:'Bebas Neue';font-size:11px;letter-spacing:4px;color:var(--gold);margin:16px 0 10px;display:flex;align-items:center;gap:8px;}
.section-tag::after{content:'';flex:1;height:1px;background:var(--border);}
.divider{height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:14px 0;}

/* PRESALE */
.presale-box{background:var(--dark2);border:1px solid var(--border);padding:16px;margin-bottom:14px;}
.presale-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border2);}
.presale-row:last-child{border:none;}
.presale-key{font-size:10px;letter-spacing:2px;color:var(--muted);font-family:'JetBrains Mono';}
.presale-val{font-family:'Bebas Neue';font-size:15px;color:var(--gold2);}
.sold-badge{background:rgba(0,230,118,0.1);border:1px solid rgba(0,230,118,0.2);padding:2px 8px;font-family:'JetBrains Mono';font-size:10px;color:var(--green);}
.phase-badge{background:rgba(212,160,23,0.1);border:1px solid var(--border);padding:2px 8px;font-family:'JetBrains Mono';font-size:10px;color:var(--gold);}

.legal-box{background:var(--dark3);border:1px solid var(--border2);padding:12px;font-size:10px;color:var(--muted2);line-height:1.7;font-family:'JetBrains Mono';margin-top:14px;}
.float-btn{position:fixed;bottom:18px;right:14px;background:rgba(34,158,217,0.15);border:1px solid rgba(34,158,217,0.3);width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;text-decoration:none;z-index:100;}

@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.wrap>*{animation:fadeUp 0.4s ease both;}
</style>
</head>
<body>
<div class="wrap">

  <div class="header">
    <div class="logo-row">
      <img src="asset/IMG-20260126-WA0020.jpg" class="logo-img" alt="Neo Pisk">
      <img src="asset/Eco Pisk.jpg" class="logo-img" alt="Eco Pisk">
    </div>
    <div class="header-title">NEO PISK</div>
    <div class="header-sub">COMPRAR $PISK Â· POLYGON</div>
  </div>

  <!-- STATUS -->
  <div class="status-bar">
    <div class="dot" id="dot"></div>
    <span id="statusTxt">Cargando...</span>
  </div>

  <!-- BALANCE -->
  <div class="balance-card">
    <div class="balance-lbl">TU BALANCE $PISK</div>
    <div class="balance-val" id="balVal">â€”</div>
    <div class="balance-addr" id="balAddr">Sin conectar</div>
  </div>

  <!-- CONECTAR -->
  <button class="btn btn-connect" id="btnConectar" onclick="conectar()">ğŸ”Œ CONECTAR METAMASK</button>

  <div class="divider"></div>

  <!-- CALCULADORA -->
  <div class="section-tag">CALCULADORA</div>
  <div class="calc-card">
    <div class="input-lbl">CANTIDAD DE USDT A INVERTIR</div>
    <input class="input-field" type="number" id="inputUSDT" placeholder="1" min="0.01" step="0.01" value="1" oninput="calcular()">
    <div class="calc-result">
      <div class="calc-result-lbl">RECIBIRÃS</div>
      <div class="calc-result-val" id="resultPisk">10 $PISK</div>
    </div>
    <div class="calc-debug" id="debugInfo">1 USDT = 10 $PISK Â· Red Polygon</div>
  </div>

  <!-- BOTONES COMPRA -->
  <button class="btn btn-approve" id="btnApprove" onclick="aprobar()" disabled>â‘  AUTORIZAR USDT</button>
  <button class="btn btn-buy"     id="btnBuy"     onclick="comprar()"  disabled>â‘¡ COMPRAR $PISK</button>

  <div class="divider"></div>

  <!-- TOKENOMICS -->
  <div class="section-tag">TOKENOMICS</div>
  <div class="presale-box">
    <div class="presale-row"><span class="presale-key">EMISIÃ“N TOTAL</span><span class="presale-val">100,000,000</span></div>
    <div class="presale-row"><span class="presale-key">POLÃTICA</span><span class="presale-val" style="font-size:12px">BUYBACK & BURN</span></div>
    <div class="presale-row"><span class="presale-key">FASE 1</span><span class="sold-badge">SOLD OUT âœ“</span></div>
    <div class="presale-row" style="border:none"><span class="presale-key">FASE 2 Â· PRECIO</span><span class="phase-badge">$0.10 USD</span></div>
  </div>

  <div class="legal-box">âš–ï¸ La adquisiciÃ³n de $PISK representa utilidad digital del ecosistema Neo Pisk. No representa inversiÃ³n financiera ni promete retornos garantizados. Red Polygon Â· Contrato verificado.</div>
  <div style="text-align:center;padding:16px 0;font-size:10px;color:var(--muted2);font-family:'JetBrains Mono';">
    Â© NEO PISK TECH SAC Â· <a href="https://neopisk.lat" style="color:var(--gold);text-decoration:none">neopisk.lat</a>
  </div>
</div>

<a href="https://t.me/NeoPisk_bot" class="float-btn" target="_blank">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="#229ED9"><path d="M9.78 18.65l.28-4.23 7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3 3.64 12c-.88-.25-.89-.86.2-1.3l15.97-6.16c.73-.33 1.43.18 1.15 1.3l-2.72 12.81c-.19.91-.74 1.13-1.5.71L12.6 16.3l-1.99 1.93c-.23.23-.42.42-.83.42z"/></svg>
</a>

<script>
// â”€â”€ CONTRATOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CONTRACT_ADDR = '0x07Fc7AC9D681Cdd3D100c68f6f5646970CC7fF60';
const USDT_ADDR     = '0xc2132D05D31c914a87C6611C10748AEb04B58e8F';
const PISK_ADDR     = '0x9d5B2A73d16dAF61712BA8527d94F6997a0E6323';

// USDT Polygon tiene 6 decimales
// PISK tiene 18 decimales
// El contrato recibe _amountUSDT en unidades de 6 decimales (microUSDT)

const USDT_ABI = [
  'function approve(address spender, uint256 amount) returns (bool)',
  'function allowance(address owner, address spender) view returns (uint256)',
  'function balanceOf(address account) view returns (uint256)'
];
const PISK_ABI = ['function balanceOf(address account) view returns (uint256)'];
const BUY_ABI  = ['function buyWithUSDT(uint256 _amountUSDT)'];

// â”€â”€ ESTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let web3     = null;
let cuenta   = null;
let aprobado = false;

// Leer params URL
const params = new URLSearchParams(window.location.search);
const UID    = params.get('uid') || '';
const REF    = params.get('ref') || '';

// â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(msg, tipo) {
  document.getElementById('statusTxt').textContent = msg;
  const d = document.getElementById('dot');
  d.className = 'dot' + (tipo==='ok'?' green':tipo==='err'?' red':tipo==='wait'?' orange':'');
}

function calcular() {
  const usdt = parseFloat(document.getElementById('inputUSDT').value) || 0;
  const pisk = usdt * 10;
  document.getElementById('resultPisk').textContent = pisk.toLocaleString() + ' $PISK';
  // Mostrar exactamente quÃ© nÃºmero se enviarÃ¡ al contrato (microUSDT)
  const microUSDT = Math.round(usdt * 1e6);
  document.getElementById('debugInfo').textContent = 
    usdt + ' USDT = ' + microUSDT + ' microUSDT â†’ ' + pisk + ' $PISK';
  aprobado = false;
  document.getElementById('btnBuy').disabled = true;
}

function habilitarBotones(on) {
  document.getElementById('btnApprove').disabled = !on;
  document.getElementById('btnBuy').disabled = true; // Buy solo se habilita tras approve
  document.getElementById('btnConectar').style.display = on ? 'none' : 'block';
}

async function actualizarBalance() {
  if (!cuenta || !web3) return;
  try {
    const pisk = new web3.eth.Contract([{constant:true,inputs:[{name:'_owner',type:'address'}],name:'balanceOf',outputs:[{name:'balance',type:'uint256'}],type:'function'}], PISK_ADDR);
    const bal  = await pisk.methods.balanceOf(cuenta).call();
    const num  = parseFloat(web3.utils.fromWei(bal, 'ether')).toFixed(2);
    document.getElementById('balVal').textContent  = parseFloat(num).toLocaleString() + ' $PISK';
    document.getElementById('balAddr').textContent = cuenta;
  } catch(e) { console.warn('balance error', e); }
}

// â”€â”€ CONECTAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function conectar() {
  if (!window.ethereum) {
    setStatus('MetaMask no detectado â€” abre desde MetaMask app', 'err');
    return;
  }
  setStatus('Conectando...', 'wait');
  try {
    web3 = new Web3(window.ethereum);
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    cuenta = accounts[0];

    // Verificar Polygon
    const chainId = await web3.eth.getChainId();
    if (chainId !== 137) {
      setStatus('Cambiando a Polygon...', 'wait');
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x89' }] });
        web3 = new Web3(window.ethereum);
      } catch(e) {
        if (e.code === 4902) {
          await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{
            chainId: '0x89', chainName: 'Polygon Mainnet',
            nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
            rpcUrls: ['https://polygon-rpc.com/'],
            blockExplorerUrls: ['https://polygonscan.com/']
          }]});
        } else throw e;
      }
    }

    setStatus('âœ… Conectado Â· ' + cuenta.slice(0,6) + '...' + cuenta.slice(-4), 'ok');
    habilitarBotones(true);
    calcular();
    await actualizarBalance();

    window.ethereum.on('accountsChanged', a => { cuenta = a[0]; actualizarBalance(); });
    window.ethereum.on('chainChanged', () => window.location.reload());

  } catch(e) {
    if (e.code === 4001) setStatus('ConexiÃ³n rechazada', 'err');
    else setStatus('Error: ' + e.message, 'err');
  }
}

// â”€â”€ APROBAR USDT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function aprobar() {
  const usdt = parseFloat(document.getElementById('inputUSDT').value);
  if (!usdt || usdt <= 0) { alert('âš ï¸ Ingresa un monto vÃ¡lido'); return; }
  if (!cuenta) { await conectar(); return; }

  // Calcular monto exacto en microUSDT (6 decimales)
  // Ejemplo: 1 USDT â†’ 1000000
  //          0.1 USDT â†’ 100000
  const microUSDT = Math.round(usdt * 1e6).toString();
  console.log('Aprobando microUSDT:', microUSDT);

  try {
    const usdt_contrato = new web3.eth.Contract([
      { constant:false, inputs:[{name:'_spender',type:'address'},{name:'_value',type:'uint256'}], name:'approve', outputs:[{name:'',type:'bool'}], type:'function' },
      { constant:true,  inputs:[{name:'_owner',type:'address'},{name:'_spender',type:'address'}], name:'allowance', outputs:[{name:'',type:'uint256'}], type:'function' }
    ], USDT_ADDR);

    const gp = Math.floor(parseInt(await web3.eth.getGasPrice()) * 1.2).toString();

    // Verificar allowance actual
    setStatus('Verificando allowance...', 'wait');
    const allowance = await usdt_contrato.methods.allowance(cuenta, CONTRACT_ADDR).call();
    console.log('Allowance actual:', allowance, 'Necesitamos:', microUSDT);

    // Si ya hay allowance mayor o igual, saltar approve
    if (parseInt(allowance) >= parseInt(microUSDT)) {
      setStatus('âœ… USDT ya autorizado â€” toca â‘¡ COMPRAR', 'ok');
      aprobado = true;
      document.getElementById('btnBuy').disabled = false;
      return;
    }

    // Si hay allowance pero menor, resetear primero
    if (parseInt(allowance) > 0) {
      setStatus('Reseteando allowance...', 'wait');
      await usdt_contrato.methods.approve(CONTRACT_ADDR, '0').send({ from: cuenta, gasPrice: gp });
      await new Promise(r => setTimeout(r, 2000));
    }

    setStatus('Aprueba ' + usdt + ' USDT en MetaMask...', 'wait');
    await usdt_contrato.methods.approve(CONTRACT_ADDR, microUSDT).send({ from: cuenta, gasPrice: gp });

    aprobado = true;
    document.getElementById('btnBuy').disabled = false;
    setStatus('âœ… USDT autorizado â€” toca â‘¡ COMPRAR', 'ok');

  } catch(e) {
    console.error('Approve error:', e);
    if (e.code === 4001) setStatus('AutorizaciÃ³n rechazada', 'err');
    else setStatus('Error approve: ' + e.message.slice(0, 60), 'err');
  }
}

// â”€â”€ COMPRAR $PISK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function comprar() {
  if (!aprobado) { alert('âš ï¸ Primero autoriza el USDT en el paso â‘ '); return; }
  if (!cuenta)   { await conectar(); return; }

  const usdt = parseFloat(document.getElementById('inputUSDT').value);
  if (!usdt || usdt <= 0) { alert('âš ï¸ Ingresa un monto vÃ¡lido'); return; }

  // MISMO cÃ¡lculo que en approve â€” microUSDT exactos
  const microUSDT = Math.round(usdt * 1e6).toString();
  console.log('Comprando con microUSDT:', microUSDT);

  try {
    const contrato = new web3.eth.Contract([
      { inputs:[{name:'_amountUSDT',type:'uint256'}], name:'buyWithUSDT', outputs:[], stateMutability:'nonpayable', type:'function' }
    ], CONTRACT_ADDR);

    const gp = Math.floor(parseInt(await web3.eth.getGasPrice()) * 1.2).toString();

    setStatus('Confirma la compra en MetaMask...', 'wait');
    const tx = await contrato.methods.buyWithUSDT(microUSDT).send({
      from:     cuenta,
      gas:      300000,
      gasPrice: gp
    });

    console.log('TX exitosa:', tx.transactionHash);
    setStatus('ğŸ‰ Â¡Compra exitosa!', 'ok');
    aprobado = false;
    document.getElementById('btnBuy').disabled = true;
    document.getElementById('inputUSDT').value = '1';
    calcular();

    // Registrar en el bot
    registrarCompra(tx.transactionHash);

    setTimeout(actualizarBalance, 5000);

  } catch(e) {
    console.error('Buy error:', e);
    if (e.code === 4001) setStatus('Compra cancelada', 'err');
    else setStatus('Error compra: ' + (e.message || 'verifica saldo USDT').slice(0, 60), 'err');
  }
}

// â”€â”€ REGISTRAR EN BOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function registrarCompra(txHash) {
  try {
    await fetch('http://69.169.109.120:3001/registrar-compra', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ txHash, uid: UID, ref: REF, wallet: cuenta })
    });
  } catch(e) { console.warn('Bot no disponible:', e); }
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', async () => {
  calcular();
  if (!window.ethereum) {
    setStatus('Abre esta pÃ¡gina dentro de MetaMask app', 'err');
    return;
  }
  setStatus('MetaMask detectado âœ… â€” conecta tu wallet', 'ok');
  web3 = new Web3(window.ethereum);
  // Intentar reconectar si ya estaba conectado
  try {
    const accounts = await web3.eth.getAccounts();
    if (accounts.length > 0) {
      cuenta = accounts[0];
      habilitarBotones(true);
      setStatus('âœ… Conectado Â· ' + cuenta.slice(0,6)+'...'+cuenta.slice(-4), 'ok');
      await actualizarBalance();
    }
  } catch(e) {}
});
</script>
</body>
</html>
