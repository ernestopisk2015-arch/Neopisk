<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoPisk | Private Sale Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #4CAF50; --secondary: #00d4ff; --bg: #051405; }
        body { 
            background-color: var(--bg); 
            color: white; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
        }
        .invest-card { 
            background: rgba(255, 255, 255, 0.05); 
            backdrop-filter: blur(10px); 
            padding: 40px; 
            border-radius: 20px; 
            border: 1px solid rgba(76, 175, 80, 0.3); 
            text-align: center; 
            width: 100%; 
            max-width: 400px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
        }
        h1 { 
            font-size: 28px; 
            margin-bottom: 10px; 
            background: linear-gradient(to right, #4CAF50, #00d4ff); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        .stats { 
            background: rgba(0,0,0,0.3); 
            padding: 15px; 
            border-radius: 10px; 
            margin: 20px 0; 
            border-left: 4px solid var(--primary); 
            text-align: left;
        }
        /* EL BOT√ìN RESPLANDECIENTE */
        .btn-invest { 
            background: linear-gradient(45deg, var(--primary), var(--secondary)); 
            color: white; 
            border: none; 
            padding: 18px 30px; 
            border-radius: 50px; 
            font-size: 18px; 
            font-weight: bold; 
            width: 100%; 
            cursor: pointer; 
            transition: 0.3s; 
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5); 
            text-transform: uppercase;
        }
        .btn-invest:hover { 
            transform: scale(1.05); 
            box-shadow: 0 0 40px rgba(0, 212, 255, 0.8); 
        }
        .btn-invest:disabled { background: #555; cursor: not-allowed; box-shadow: none; }
        
        #status { margin-top: 20px; font-size: 14px; color: #ffeb3b; min-height: 20px; }
        .security-badge { font-size: 12px; margin-top: 30px; opacity: 0.6; }
    </style>
</head>
<body>

<div class="invest-card">
    <h1>EcoPisk Investment</h1>
    <p>Official Private Sale Portal</p>
    
    <div class="stats">
        <div>Asset: <strong>PISK Token</strong></div>
        <div>Price: <strong>0.10 USDT</strong></div>
        <div>Network: <strong>Polygon</strong></div>
    </div>

    <button id="buyBtn" class="btn-invest" onclick="startInvestment()">Buy 5 PISK (0.5 USDT)</button>
    
    <div id="status">Waiting for MetaMask connection...</div>

    <div class="security-badge">
        üõ°Ô∏è Secure Smart Contract | Verified on Polygonscan
    </div>
</div>

<script>
    // DIRECCIONES OFICIALES
    const VENTA_ADDR_RAW = "0x86A0Bb8440189051fB38298Ef3a93E958597E51f";
    const USDT_ADDR_RAW = "0xc2132D05D31c914a87C6611C10748AEb04B58e8F";

    async function startInvestment() {
        const status = document.getElementById("status");
        const btn = document.getElementById("buyBtn");

        if (!window.ethereum) {
            status.innerText = "‚ùå Please install MetaMask";
            return;
        }

        try {
            btn.disabled = true;
            status.innerText = "Connecting to your wallet...";
            
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            const signer = provider.getSigner();
            
            // AUTO-CORRECCI√ìN DE CHECKSUM: Esto evita el error de may√∫sculas/min√∫sculas
            const vAddr = ethers.utils.getAddress(VENTA_ADDR_RAW);
            const uAddr = ethers.utils.getAddress(USDT_ADDR_RAW);

            // PASO 1: APROBAR EL GASTO DE USDT
            status.innerText = "Step 1/2: Authorizing USDT...";
            const usdtContract = new ethers.Contract(uAddr, ["function approve(address s, uint256 a) public returns (bool)"], signer);
            const tx1 = await usdtContract.approve(vAddr, "500000"); // 0.5 USDT
            status.innerText = "Waiting for Blockchain approval...";
            await tx1.wait();

            // PASO 2: REALIZAR LA COMPRA
            status.innerText = "Step 2/2: Confirming Purchase...";
            const saleContract = new ethers.Contract(vAddr, ["function comprar(uint256 a) public"], signer);
            const tx2 = await saleContract.comprar("500000");
            status.innerText = "Finalizing transaction...";
            await tx2.wait();

            status.innerText = "‚úÖ SUCCESS! You are now a PISK holder.";
            btn.innerText = "TRANSACTION COMPLETE";
        } catch (e) {
            console.error(e);
            btn.disabled = false;
            if (e.message.includes("user rejected")) {
                status.innerText = "‚ùå Transaction cancelled by user.";
            } else if (e.message.includes("insufficient funds")) {
                status.innerText = "‚ùå Error: Insufficient MATIC or USDT.";
            } else {
                status.innerText = "‚ùå Error: Check MATIC/USDT balance.";
            }
        }
    }
</script>

</body>
</html>
