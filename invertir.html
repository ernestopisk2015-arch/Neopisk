<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neo Pisk - Founder Portal</title>
    
    <link rel="icon" type="image/jpg" href="asset/IMG-20260126-WA0020.jpg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>

    <style>
        :root {
            --gold: #d4af37;
            --gold-light: #f9e2af;
            --cyan: #00d2ff;
            --bg-dark: #080808;
            --panel-bg: #121212;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            padding: 10px; 
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            color: white;
            min-height: 100vh;
        }

        .main-container { max-width: 1000px; margin: 0 auto; padding-bottom: 50px; }

        /* CABECERA */
        .header { text-align: center; border-bottom: 1px solid var(--gold); padding: 30px 0; margin-bottom: 30px; }
        .logo-row img { width: 90px; filter: drop-shadow(0 0 10px var(--gold)); margin: 0 15px; border-radius: 50%; }
        h1 { color: var(--gold); letter-spacing: 4px; font-size: 2.2em; margin: 15px 0 5px 0; }

        /* PANEL CENTRAL DE COMPRA */
        .center-panel {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--cyan);
            border-radius: 30px;
            padding: 40px 20px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 210, 255, 0.2);
            margin-bottom: 40px;
        }

        .balance-box { background: #000; padding: 15px; border-radius: 15px; border: 1px solid #222; margin-bottom: 25px; }
        #saldoDisplay { font-size: 38px; color: var(--cyan); font-weight: bold; }

        input { 
            width: 80%; padding: 15px; border-radius: 12px; border: 1px solid #333; 
            background: #000; color: var(--cyan); font-size: 22px; text-align: center; margin-bottom: 20px; outline: none;
        }

        button { 
            width: 85%; padding: 16px; margin: 8px 0; border-radius: 12px; border: none; 
            font-weight: bold; cursor: pointer; transition: 0.3s; text-transform: uppercase; 
        }
        .btn-buy { background: var(--cyan); color: #000; box-shadow: 0 4px 15px rgba(0,210,255,0.4); font-size: 16px; }
        .btn-approve { background: #333; color: #fff; }

        /* PREVENTA ESTILIZADA */
        .presale-container {
            background: linear-gradient(145deg, #151515, #0a0a0a);
            border: 1px solid var(--gold);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
        }
        .presale-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .phase-badge { background: var(--gold); color: #000; padding: 4px 12px; border-radius: 5px; font-size: 12px; font-weight: bold; }
        .progress-bar { background: #222; height: 10px; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .progress-fill { background: var(--gold); height: 100%; width: 15%; border-radius: 10px; box-shadow: 0 0 10px var(--gold); }

        /* SECCI√ìN DE INSTRUCCIONES DUAL */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .info-card { background: var(--panel-bg); padding: 25px; border-radius: 20px; border: 1px solid #333; text-align: center; }
        .flag-icon { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--gold); margin-bottom: 15px; object-fit: cover; }
        
        .btn-metamask {
            background-image: linear-gradient(rgba(0,0,0,0.65), rgba(0,0,0,0.65)), url('asset/metamasklogo.jpg');
            background-size: cover; height: 50px; border: 1px solid var(--gold); color: #fff; 
            border-radius: 10px; width: 100%; cursor: pointer; font-size: 11px; font-weight: bold; margin-bottom: 10px;
        }

        .btn-support-ws {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            background: #25D366; color: black; padding: 12px; border-radius: 10px; 
            text-decoration: none; font-weight: bold; font-size: 12px; margin-top: 10px;
        }

        .legal-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .legal-box { border: 1px solid rgba(212, 175, 55, 0.3); padding: 15px; border-radius: 10px; font-size: 11px; color: #888; text-align: justify; background: rgba(0,0,0,0.3); }

        .footer { text-align: center; padding: 40px 0; border-top: 1px solid #222; font-size: 13px; color: #555; }
        .footer a { color: var(--gold); text-decoration: none; }

        .btn-whatsapp-float {
            position: fixed; bottom: 20px; right: 20px; background: #25D366; color: white; 
            width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; 
            justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); text-decoration: none; z-index: 1000;
        }

        /* ALERTA M√ìVIL */
        .mobile-alert {
            background: linear-gradient(135deg, #f6851b, #e2761b);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 13px;
            font-weight: bold;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            box-shadow: 0 4px 15px rgba(246, 133, 27, 0.3);
        }

        @media (max-width: 768px) { 
            .presale-grid, .info-grid, .legal-container { grid-template-columns: 1fr; }
            h1 { font-size: 1.5em; }
            #saldoDisplay { font-size: 28px; }
        }
    </style>
</head>
<body>

<div class="main-container">
    
    <!-- ALERTA PARA M√ìVIL -->
    <div id="mobileAlert" class="mobile-alert">
        üì± <b>IMPORTANTE:</b> Est√°s en m√≥vil. Despu√©s de dar "Continuar" en MetaMask, espera 3-5 segundos para que se conecte.
    </div>

    <div class="header">
        <div class="logo-row">
            <img src="asset/IMG-20260126-WA0020.jpg" alt="Logo Neo">
            <img src="asset/Eco Pisk.jpg" alt="Logo Eco">
        </div>
        <h1>NEO PISK & ECO PISK</h1>
        <p style="color: var(--gold); letter-spacing: 5px; font-size: 11px;">FOUNDER PARTNER PORTAL ‚Ä¢ SOCIO FUNDADOR</p>
    </div>

    <div class="center-panel">
        <div class="balance-box">
            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">TU SALDO / YOUR BALANCE</div>
            <div id="saldoDisplay">0.00 $PISK</div>
        </div>
        <button class="btn-approve" style="background: transparent; border: 1px solid var(--cyan); color: var(--cyan);" onclick="conectarWallet()">üîç CONECTAR BILLETERA</button>
        <input type="number" id="inputUSDT" placeholder="Monto USDT">
        <button class="btn-approve" onclick="approveUSDT()">1. AUTORIZAR USDT</button>
        <button class="btn-buy" onclick="buyPisk()">2. ADQUIRIR TOKENS $PISK</button>
        <div id="status" style="font-size: 12px; margin-top: 15px; color: #d4af37; font-weight: bold;">Listo en Polygon Network</div>
    </div>

    <div class="presale-container">
        <h3 style="text-align: center; color: var(--gold); margin-top: 0; letter-spacing: 2px;">üíé TOKENOMICS SOCIO FUNDADOR</h3>
        <div class="presale-grid">
            <div style="border-right: 1px solid #222; padding-right: 20px;">
                <p><b>EMISI√ìN TOTAL:</b> 100,000,000 $PISK</p>
                <p><b>POL√çTICA:</b> BUYBACK & BURN</p>
                <p><span class="phase-badge">FASE 1</span> <span style="color: #39FF14;">SOLD OUT 100%</span></p>
                <p><span class="phase-badge">FASE 2</span> ACTUAL: $0.10 USD</p>
                <div class="progress-bar"><div class="progress-fill"></div></div>
                <small>15% Completado</small>
            </div>
            <div style="padding-left: 10px;">
                <p><b>TOTAL SUPPLY:</b> 100,000,000 $PISK</p>
                <p><b>POLICY:</b> BUYBACK & BURN</p>
                <p><span class="phase-badge">PHASE 1</span> <span style="color: #39FF14;">SOLD OUT 100%</span></p>
                <p><span class="phase-badge">PHASE 2</span> CURRENT: $0.10 USD</p>
                <div class="progress-bar"><div class="progress-fill"></div></div>
                <small>15% Completed</small>
            </div>
        </div>
    </div>

    <div class="info-grid">
        <div class="info-card">
            <img src="https://flagcdn.com/w160/es.png" class="flag-icon" alt="Espa√±a">
            <h4 style="color: var(--gold); margin: 0 0 15px 0;">INSTRUCCIONES M√ìVIL</h4>
            <p style="font-size: 13px; text-align: left; margin-bottom: 15px;">
                <b>üì± Paso a paso Android:</b><br>
                1. Copia la URL debajo<br>
                2. Abre la app MetaMask<br>
                3. Ve al navegador (üîç)<br>
                4. Pega la URL y entra<br>
                5. Conecta normalmente
            </p>
            <button onclick="copiarURL()" class="btn-metamask">üìã COPIAR URL</button>
            <button onclick="copyContract()" style="background:#000; color:var(--gold); border:1px dashed var(--gold); font-size:10px; padding:10px; width: 100%; cursor: pointer;">COPIAR CONTRATO $PISK</button>
            <a href="https://wa.me/51908066095" class="btn-support-ws" target="_blank">üí¨ SOPORTE WHATSAPP</a>
        </div>

        <div class="info-card">
            <img src="https://flagcdn.com/w160/us.png" class="flag-icon" alt="USA">
            <h4 style="color: var(--gold); margin: 0 0 15px 0;">MOBILE INSTRUCTIONS</h4>
            <p style="font-size: 13px; text-align: left; margin-bottom: 15px;">
                <b>üì± Android Step-by-step:</b><br>
                1. Copy URL below<br>
                2. Open MetaMask app<br>
                3. Go to browser (üîç)<br>
                4. Paste URL and enter<br>
                5. Connect normally
            </p>
            <button onclick="copiarURL()" class="btn-metamask">üìã COPY URL</button>
            <button onclick="copyContract()" style="background:#000; color:var(--gold); border:1px dashed var(--gold); font-size:10px; padding:10px; width: 100%; cursor: pointer;">COPY $PISK CONTRACT</button>
            <a href="https://wa.me/51908066095" class="btn-support-ws" target="_blank">üí¨ WHATSAPP SUPPORT</a>
        </div>
    </div>

    <div class="legal-container">
        <div class="legal-box">
            <b style="color: var(--gold);">‚öñÔ∏è AVISO LEGAL:</b> La adquisici√≥n de $PISK representa utilidad digital dise√±ada para el ecosistema Neo Pisk. El usuario acepta la gobernanza digital para el desarrollo de infraestructura en Lima Este.
        </div>
        <div class="legal-box">
            <b style="color: var(--gold);">‚öñÔ∏è LEGAL NOTICE:</b> The acquisition of $PISK represents digital utility for the Neo Pisk ecosystem. The user accepts digital governance for infrastructure development in East Lima.
        </div>
    </div>

    <div class="footer">
        <p>Propiedad Oficial: <b>Neo Pisk & Eco Pisk</b></p>
        <p>Web: <a href="https://neopisk.lat/" target="_blank">neopisk.lat</a></p>
    </div>
</div>

<a href="https://wa.me/51908066095" class="btn-whatsapp-float" target="_blank">
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" width="35" alt="WhatsApp">
</a>

<script>
    // CONFIGURACI√ìN DE SMART CONTRACTS
    const contractAddr = "0x07Fc7AC9D681Cdd3D100c68f6f5646970CC7fF60"; 
    const usdtAddr = "0xc2132D05D31c914a87C6611C10748AEb04B58e8F"; 
    const piskAddr = "0x9d5B2A73d16dAF61712BA8527d94F6997a0E6323";

    const minABI = [
        { "constant": false, "inputs": [{ "name": "_spender", "type": "address" }, { "name": "_value", "type": "uint256" }], "name": "approve", "outputs": [{ "name": "", "type": "bool" }], "type": "function" },
        { "constant": true, "inputs": [{ "name": "_owner", "type": "address" }], "name": "balanceOf", "outputs": [{ "name": "balance", "type": "uint256" }], "type": "function" },
        { "constant": true, "inputs": [{ "name": "_owner", "type": "address" }, { "name": "_spender", "type": "address" }], "name": "allowance", "outputs": [{ "name": "", "type": "uint256" }], "type": "function" }
    ];

    const buyABI = [{ "inputs": [{ "name": "_amountUSDT", "type": "uint256" }], "name": "buyWithUSDT", "outputs": [], "stateMutability": "nonpayable", "type": "function" }];

    // Variables globales
    let web3Instance = null;
    let cuentaConectada = null;

    // ========== FUNCIONES DE UTILIDAD ==========
    
    function esMobil() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    function copiarURL() { 
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            alert("‚úÖ URL copiada!\n\nAhora:\n1. Abre MetaMask en tu tel√©fono\n2. Toca el √≠cono del navegador üîç\n3. Pega esta URL\n4. Conecta tu wallet");
        }).catch(() => {
            prompt("Copia esta URL:", url);
        }); 
    }
    
    function copyContract() { 
        navigator.clipboard.writeText(piskAddr).then(() => {
            alert("‚úÖ Contrato $PISK copiado:\n" + piskAddr);
        }); 
    }

    // ========== DETECCI√ìN Y CONFIGURACI√ìN INICIAL ==========

    async function detectarProvider() {
        // Esperar un poco para que MetaMask se inyecte
        await new Promise(resolve => setTimeout(resolve, 300));

        if (typeof window.ethereum !== 'undefined') {
            console.log('‚úÖ Provider detectado');
            
            // Configurar provider correcto
            let provider = window.ethereum;
            
            // Si hay m√∫ltiples providers, buscar MetaMask
            if (window.ethereum.providers?.length) {
                const metamaskProvider = window.ethereum.providers.find(p => p.isMetaMask);
                if (metamaskProvider) provider = metamaskProvider;
            }
            
            web3Instance = new Web3(provider);
            return true;
        }
        
        console.log('‚ùå No se detect√≥ MetaMask');
        return false;
    }

    // ========== FUNCI√ìN PRINCIPAL DE CONEXI√ìN ==========

    async function conectarWallet() {
        document.getElementById("status").innerText = "‚è≥ Conectando...";
        
        // Detectar provider
        const tieneProvider = await detectarProvider();
        
        if (!tieneProvider) {
            if (esMobil()) {
                alert("‚ö†Ô∏è MetaMask no detectado\n\nüì± PASOS:\n1. Abre la app MetaMask\n2. Toca el navegador üîç\n3. Pega esta URL y vuelve");
                copiarURL();
            } else {
                alert("‚ùå MetaMask no instalado\n\nInstala la extensi√≥n desde:\nmetamask.io");
            }
            document.getElementById("status").innerText = "‚ùå MetaMask no detectado";
            return;
        }

        try {
            // Mostrar alerta en m√≥vil
            if (esMobil()) {
                document.getElementById("mobileAlert").style.display = "block";
            }

            // Solicitar cuentas con timeout
            const accountsPromise = window.ethereum.request({ 
                method: 'eth_requestAccounts' 
            });

            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Timeout')), 60000)
            );

            const accounts = await Promise.race([accountsPromise, timeoutPromise]);

            if (!accounts || accounts.length === 0) {
                throw new Error("No se obtuvieron cuentas");
            }

            cuentaConectada = accounts[0];
            console.log('‚úÖ Cuenta conectada:', cuentaConectada);

            // Verificar red
            const chainId = await web3Instance.eth.getChainId();
            console.log('Red actual:', chainId);

            if (chainId !== 137) {
                document.getElementById("status").innerText = "‚ö†Ô∏è Cambiando a Polygon...";
                
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x89' }], // 137 en hex
                    });
                } catch (switchError) {
                    // Si la red no est√° agregada, agregarla
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x89',
                                chainName: 'Polygon Mainnet',
                                nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                                rpcUrls: ['https://polygon-rpc.com/'],
                                blockExplorerUrls: ['https://polygonscan.com/']
                            }]
                        });
                    } else {
                        throw switchError;
                    }
                }
            }

            // Obtener saldo
            await actualizarSaldo();
            
            document.getElementById("status").innerText = "‚úÖ Conectado: " + cuentaConectada.substring(0, 6) + "..." + cuentaConectada.substring(38);

            // Ocultar alerta m√≥vil despu√©s de conectar
            if (esMobil()) {
                setTimeout(() => {
                    document.getElementById("mobileAlert").style.display = "none";
                }, 3000);
            }

        } catch (error) {
            console.error('Error al conectar:', error);
            
            if (error.code === 4001) {
                document.getElementById("status").innerText = "‚ùå Conexi√≥n rechazada";
            } else if (error.message === 'Timeout') {
                document.getElementById("status").innerText = "‚è≥ Esperando aprobaci√≥n en MetaMask...";
            } else {
                document.getElementById("status").innerText = "‚ùå Error: " + error.message;
            }
        }
    }

    async function actualizarSaldo() {
        if (!cuentaConectada) return;
        
        try {
            const pisk = new web3Instance.eth.Contract(minABI, piskAddr);
            const bal = await pisk.methods.balanceOf(cuentaConectada).call();
            const normal = parseFloat(web3Instance.utils.fromWei(bal, 'ether')).toFixed(2);
            document.getElementById("saldoDisplay").innerText = normal + " $PISK";
        } catch (e) {
            console.error("Error al obtener saldo:", e);
        }
    }

    async function getSafeGasPrice() {
        const gasPrice = await web3Instance.eth.getGasPrice();
        return Math.floor(parseInt(gasPrice) * 1.2).toString();
    }

    // ========== FUNCIONES DE COMPRA ==========

    async function approveUSDT() {
        const val = document.getElementById("inputUSDT").value;
        if(!val || val <= 0) {
            alert("‚ö†Ô∏è Ingresa un monto v√°lido de USDT");
            return;
        }

        if (!cuentaConectada) {
            alert("‚ö†Ô∏è Primero conecta tu billetera");
            await conectarWallet();
            return;
        }

        try {
            const usdt = new web3Instance.eth.Contract(minABI, usdtAddr);
            const montoFinal = (parseFloat(val) * 1000000).toFixed(0);
            const gasPrice = await getSafeGasPrice();

            document.getElementById("status").innerText = "‚è≥ Verificando permisos...";
            
            const allowance = await usdt.methods.allowance(cuentaConectada, contractAddr).call();
            
            if (parseInt(allowance) > 0) {
                document.getElementById("status").innerText = "‚è≥ Reseteando permiso...";
                await usdt.methods.approve(contractAddr, "0").send({ 
                    from: cuentaConectada, 
                    gasPrice: gasPrice 
                });
                await new Promise(resolve => setTimeout(resolve, 2000));
            }

            document.getElementById("status").innerText = "‚è≥ Aprueba " + val + " USDT en MetaMask...";
            
            const tx = await usdt.methods.approve(contractAddr, montoFinal).send({ 
                from: cuentaConectada,
                gasPrice: gasPrice
            });

            console.log('Approve TX:', tx);
            document.getElementById("status").innerText = "‚úÖ USDT Autorizado! ‚Üí Ahora paso 2";
            
        } catch (e) { 
            console.error("Error en approve:", e);
            
            if (e.code === 4001) {
                document.getElementById("status").innerText = "‚ùå Rechazaste la autorizaci√≥n";
            } else {
                document.getElementById("status").innerText = "‚ùå Error: Verifica tu saldo USDT";
            }
        }
    }

    async function buyPisk() {
        const val = document.getElementById("inputUSDT").value;
        if(!val || val <= 0) {
            alert("‚ö†Ô∏è Primero autoriza un monto en el paso 1");
            return;
        }

        if (!cuentaConectada) {
            alert("‚ö†Ô∏è Primero conecta tu billetera");
            await conectarWallet();
            return;
        }

        try {
            const neo = new web3Instance.eth.Contract(buyABI, contractAddr);
            const montoFinal = (parseFloat(val) * 1000000).toFixed(0);
            const gasPrice = await getSafeGasPrice();

            document.getElementById("status").innerText = "üöÄ Confirma la compra en MetaMask...";
            
            const tx = await neo.methods.buyWithUSDT(montoFinal).send({ 
                from: cuentaConectada,
                gas: 300000,
                gasPrice: gasPrice
            });

            console.log('Compra TX:', tx);
            document.getElementById("status").innerText = "üéâ ¬°COMPRA EXITOSA! Actualizando...";
            
            setTimeout(async () => {
                await actualizarSaldo();
                document.getElementById("inputUSDT").value = "";
            }, 3000);
            
        } catch (e) { 
            console.error("Error en compra:", e);
            
            if (e.code === 4001) {
                document.getElementById("status").innerText = "‚ùå Cancelaste la compra";
            } else {
                document.getElementById("status").innerText = "‚ùå Error: Verifica autorizaci√≥n y saldo";
            }
        }
    }

    // ========== LISTENERS DE EVENTOS ==========

    if (typeof window.ethereum !== 'undefined') {
        window.ethereum.on('accountsChanged', function (accounts) {
            if (accounts.length === 0) {
                cuentaConectada = null;
                document.getElementById("saldoDisplay").innerText = "0.00 $PISK";
                document.getElementById("status").innerText = "Desconectado";
            } else {
                cuentaConectada = accounts[0];
                actualizarSaldo();
            }
        });

        window.ethereum.on('chainChanged', function () {
            window.location.reload();
        });
    }

    // ========== INICIALIZACI√ìN ==========
    window.addEventListener('load', async function() {
        console.log('üöÄ P√°gina cargada');
        
        // Detectar provider al cargar
        await detectarProvider();
        
        // Si ya hay cuentas conectadas, actualizar
        if (web3Instance) {
            try {
                const accounts = await web3Instance.eth.getAccounts();
                if (accounts && accounts.length > 0) {
                    cuentaConectada = accounts[0];
                    await actualizarSaldo();
                    document.getElementById("status").innerText = "‚úÖ Ya conectado";
                }
            } catch (e) {
                console.log('No hay cuentas previamente conectadas');
            }
        }
    });
</script>

</body>
</html>

    
