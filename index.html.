<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEO PISK - COMPRA DIRECTA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white flex items-center justify-center min-h-screen p-6">

    <div class="bg-white text-slate-900 p-8 rounded-3xl shadow-2xl w-full max-w-sm border-t-8 border-orange-500 text-center">
        <h1 class="text-3xl font-black italic mb-2">NEO PISK</h1>
        <p class="text-xs font-bold text-slate-400 mb-6 tracking-widest uppercase">CEO Ernesto Piskulich</p>

        <input type="number" id="c" placeholder="Cantidad de $PISK" class="w-full p-4 rounded-2xl border-2 border-slate-100 bg-slate-50 text-2xl font-black mb-4 outline-none focus:border-orange-500 text-center">

        <button id="b" class="w-full bg-orange-500 text-white font-black py-5 rounded-2xl text-xl shadow-xl active:scale-95 transition-all">
            EJECUTAR COMPRA
        </button>

        <p class="mt-6 text-[10px] text-slate-400 font-bold italic uppercase leading-tight">
            "Todo lo puedo en Cristo que me fortalece"
        </p>
    </div>

    <script>
        const PISK = "0x82e21b777176587C653069176317b628574Cc5fC";
        const USDT = "0xc2132D05D31C914A87C6611C10748AEB04B58e8F";

        document.getElementById('b').onclick = async () => {
            if (!window.ethereum) return alert("Usa MetaMask");
            const cant = document.getElementById('c').value;
            if (!cant || cant <= 0) return alert("Escribe una cantidad");

            try {
                // Forzar reconexión
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const user = await signer.getAddress();

                const uCon = new ethers.Contract(USDT, ["function approve(address s, uint256 a) public returns (bool)", "function allowance(address o, address s) view returns (uint256)"], signer);
                const pCon = new ethers.Contract(PISK, ["function comprar(uint256 a) public"], signer);

                const total = BigInt(cant) * BigInt(10000); // 0.01 USDT (6 decimales)

                // REVISAR SI YA TIENE PERMISO
                const allow = await uCon.allowance(user, PISK);
                
                if (allow < total) {
                    alert("PASO 1: Aprueba el USDT");
                    const tx1 = await uCon.approve(PISK, total);
                    await tx1.wait();
                }

                alert("PASO 2: Confirma la Compra");
                const tx2 = await pCon.comprar(cant);
                await tx2.wait();

                alert("¡COMPRA EXITOSA!");
            } catch (e) {
                console.error(e);
                alert("La red está lenta o falta POL. Reintenta en 10 segundos.");
            }
        };
    </script>
</body>
</html>
