<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>$PISK Airdrop</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #D4A017; --gold2: #F0C040; --gold3: #FFF3B0;
    --dark: #07090C; --dark2: #0D1117; --dark3: #131A24;
    --border: rgba(212,160,23,0.2);
    --text: #E8EDF5; --muted: #5A6A7A;
    --green: #00E676; --red: #FF3D3D; --blue: #1A6EFF;
  }
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body { background:var(--dark); color:var(--text); font-family:'Rajdhani',sans-serif; min-height:100vh; overflow-x:hidden; padding-bottom:80px; }
  .header { background:linear-gradient(180deg,#0D1117 0%,transparent 100%); padding:16px 16px 0; position:sticky; top:0; z-index:50; }
  .user-bar { display:flex; align-items:center; gap:10px; margin-bottom:16px; }
  .avatar { width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--gold),#5A3800);display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:18px;color:var(--dark);border:2px solid var(--gold);flex-shrink:0; }
  .user-name { font-size:15px; font-weight:700; }
  .user-code { font-size:10px; color:var(--muted); letter-spacing:2px; }
  .lang-select { margin-left:auto; background:rgba(212,160,23,0.1); border:1px solid var(--border); color:var(--gold); padding:4px 8px; font-size:12px; font-family:'Rajdhani',sans-serif; outline:none; }
  .balance-card { margin:0 12px 16px; background:linear-gradient(135deg,#0D1117,#131A24,#1A2030); border:1px solid var(--border); padding:20px 16px; position:relative; overflow:hidden; }
  .balance-card::before { content:'$PISK'; position:absolute; right:-10px; top:-10px; font-family:'Bebas Neue',sans-serif; font-size:70px; color:rgba(212,160,23,0.04); pointer-events:none; }
  .bal-label { font-size:10px; letter-spacing:4px; color:var(--muted); }
  .bal-amount { font-family:'Bebas Neue',sans-serif; font-size:52px; line-height:1; background:linear-gradient(135deg,var(--gold),var(--gold2),var(--gold3)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
  .bal-usd { font-size:13px; color:var(--muted); margin-bottom:12px; }
  .bal-row { display:flex; gap:16px; padding-top:12px; border-top:1px solid var(--border); }
  .bal-item .val { font-family:'Bebas Neue',sans-serif; font-size:20px; color:var(--green); }
  .bal-item .lbl { font-size:9px; letter-spacing:2px; color:var(--muted); }
  .tabs { display:flex; gap:1px; padding:0 12px; margin-bottom:12px; background:var(--border); }
  .tab { flex:1; padding:10px 4px; text-align:center; font-family:'Bebas Neue',sans-serif; font-size:13px; letter-spacing:1px; color:var(--muted); background:var(--dark2); cursor:pointer; border:none; transition:all 0.2s; }
  .tab.active { background:var(--dark3); color:var(--gold); border-bottom:2px solid var(--gold); }
  .tab-content { padding:0 12px; display:none; }
  .tab-content.active { display:block; }
  .sec-title { font-family:'Bebas Neue',sans-serif; font-size:12px; letter-spacing:4px; color:var(--muted); margin-bottom:10px; padding-left:2px; }
  .mission-card { background:var(--dark2); border:1px solid var(--border); padding:14px 12px; margin-bottom:8px; display:flex; align-items:center; gap:12px; cursor:pointer; transition:all 0.2s; position:relative; overflow:hidden; }
  .mission-card::before { content:''; position:absolute; left:0; top:0; bottom:0; width:3px; background:var(--gold); transform:scaleY(0); transition:transform 0.2s; }
  .mission-card:active::before { transform:scaleY(1); }
  .mission-card.done { opacity:0.5; cursor:default; }
  .mission-card.done::before { background:var(--green); transform:scaleY(1); }
  .m-icon { font-size:26px; flex-shrink:0; }
  .m-info { flex:1; }
  .m-name { font-size:15px; font-weight:700; line-height:1.2; }
  .m-desc { font-size:11px; color:var(--muted); margin-top:2px; }
  .m-reward { text-align:right; flex-shrink:0; }
  .m-pts { font-family:'Bebas Neue',sans-serif; font-size:20px; color:var(--gold2); line-height:1; }
  .m-lbl { font-size:9px; color:var(--muted); letter-spacing:1px; }
  .m-check { width:22px;height:22px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:12px; }
  .m-check.done { background:var(--green); border-color:var(--green); color:var(--dark); }
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:200; display:none; align-items:flex-end; }
  .modal-overlay.show { display:flex; }
  .modal { background:var(--dark2); border-top:1px solid var(--border); width:100%; padding:20px 16px 36px; border-radius:18px 18px 0 0; animation:slideUp 0.3s ease; max-height:88vh; overflow-y:auto; }
  @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
  .modal-handle { width:36px;height:4px;background:var(--border);margin:0 auto 16px;border-radius:2px; }
  .modal-title { font-family:'Bebas Neue',sans-serif; font-size:26px; letter-spacing:2px; color:var(--gold); margin-bottom:8px; }
  .modal-desc { font-size:14px; color:var(--muted); line-height:1.6; margin-bottom:16px; }
  .modal-reward { background:rgba(212,160,23,0.08); border:1px solid var(--border); padding:12px 14px; margin-bottom:16px; display:flex; align-items:center; gap:10px; }
  .modal-pts { font-family:'Bebas Neue',sans-serif; font-size:34px; color:var(--gold2); }
  .modal-pts-sub { font-size:11px; color:var(--muted); letter-spacing:2px; }
  .m-input { width:100%; background:var(--dark3); border:1px solid var(--border); color:var(--text); padding:12px 12px; font-family:'Rajdhani',sans-serif; font-size:15px; outline:none; margin-bottom:10px; transition:border-color 0.2s; }
  .m-input:focus { border-color:var(--gold); }
  .btn-full { width:100%; padding:15px; font-family:'Bebas Neue',sans-serif; font-size:19px; letter-spacing:3px; border:none; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:8px; }
  .btn-gold { background:linear-gradient(135deg,var(--gold),#8B6914); color:var(--dark); }
  .btn-gold:active { transform:scale(0.98); }
  .btn-ghost { background:none; border:1px solid var(--border); color:var(--muted); margin-top:8px; }
  .social-row { display:flex; align-items:center; gap:10px; padding:10px; background:var(--dark3); border:1px solid var(--border); margin-bottom:6px; text-decoration:none; color:var(--text); }
  .social-row .si { font-size:22px; }
  .social-row .sn { font-size:14px; font-weight:600; }
  .social-row .su { font-size:10px; color:var(--muted); }
  .rank-item { display:flex; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.04); }
  .rank-n { font-family:'Bebas Neue',sans-serif; font-size:22px; width:28px; text-align:center; flex-shrink:0; }
  .rk1{color:#FFD700} .rk2{color:#C0C0C0} .rk3{color:#CD7F32} .rkn{color:var(--muted)}
  .rank-av { width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--gold),#2A1A00);display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:14px;color:var(--dark);flex-shrink:0; }
  .rank-info { flex:1; }
  .rank-name { font-weight:700; font-size:14px; }
  .rank-sub { font-size:10px; color:var(--muted); }
  .rank-pisk { font-family:'Bebas Neue',sans-serif; font-size:18px; color:var(--gold2); }
  .ref-box { background:var(--dark3); border:1px solid var(--border); padding:16px; text-align:center; margin-bottom:12px; }
  .ref-levels { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; margin-bottom:12px; }
  .ref-lv { background:var(--dark3); border:1px solid var(--border); padding:12px 8px; text-align:center; }
  .ref-lv .pct { font-family:'Bebas Neue',sans-serif; font-size:26px; color:var(--gold2); }
  .ref-lv .lbl { font-size:9px; letter-spacing:2px; color:var(--muted); }
  .ref-stats { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
  .ref-st { background:var(--dark3); border:1px solid var(--border); padding:12px; text-align:center; }
  .ref-st .val { font-family:'Bebas Neue',sans-serif; font-size:26px; color:var(--green); }
  .ref-st .lbl { font-size:9px; letter-spacing:2px; color:var(--muted); }
  .toast { position:fixed; top:16px; left:50%; transform:translateX(-50%) translateY(-80px); background:var(--dark3); border:1px solid var(--gold); padding:10px 18px; font-size:14px; font-weight:600; transition:transform 0.3s; z-index:300; white-space:nowrap; box-shadow:0 4px 20px rgba(212,160,23,0.3); }
  .toast.show { transform:translateX(-50%) translateY(0); }
  .overlay{position:fixed;inset:0;background:#07090C;z-index:200;display:none;flex-direction:column;}
  .overlay.show{display:flex;}
  .game-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0;}
  .game-header .title{font-family:'Bebas Neue';font-size:18px;letter-spacing:2px;color:var(--gold);flex:1;}
  .close-btn{background:rgba(255,61,61,0.15);border:1px solid var(--red,#FF3D3D);color:var(--red,#FF3D3D);padding:6px 14px;font-family:'Bebas Neue';font-size:13px;cursor:pointer;}
  .score-item{text-align:center;}
  .score-val{font-family:'Bebas Neue';font-size:20px;color:var(--gold2);}
  .score-lbl{font-size:9px;letter-spacing:2px;color:var(--muted);}
  .game-area{flex:1;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;}
  .trivia-opt{background:var(--dark3);border:2px solid var(--border);padding:14px 10px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;text-align:center;line-height:1.3;}
  .float-pts{position:absolute;font-family:'Bebas Neue';font-size:24px;color:var(--gold2);pointer-events:none;animation:floatUp 0.8s ease forwards;}
  @keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-80px) scale(0.5)}}
  .spinner { width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 12px; }
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading { text-align:center; padding:40px 20px; color:var(--muted); }
</style>
</head>
<body>
<div class="toast" id="toast"></div>
<div class="header">
  <div class="user-bar">
    <div class="avatar" id="userAvatar">?</div>
    <div>
      <div class="user-name" id="userName">Cargando...</div>
      <div class="user-code" id="userCode">CÃ“DIGO: â€”</div>
    </div>
    <select class="lang-select" id="langSelect" onchange="cambiarIdioma(this.value)">
      <option value="es">ğŸ‡ªğŸ‡¸ ES</option>
      <option value="en">ğŸ‡ºğŸ‡¸ EN</option>
      <option value="pt">ğŸ‡§ğŸ‡· PT</option>
    </select>
  </div>
  <div class="balance-card">
    <div class="bal-label">BALANCE TOTAL</div>
    <div class="bal-amount" id="balAmt">0</div>
    <div style="font-family:'Bebas Neue';font-size:16px;color:var(--gold);margin-top:-4px;">$PISK</div>
    <div class="bal-usd" id="balUsd">â‰ˆ $0.00 USD</div>
    <div class="bal-row">
      <div class="bal-item"><div class="val" id="balUsdt">$0.00</div><div class="lbl">USDT PENDIENTE</div></div>
      <div class="bal-item"><div class="val" id="balRefs">0</div><div class="lbl">REFERIDOS</div></div>
      <div class="bal-item"><div class="val" id="balMis">0/9</div><div class="lbl">MISIONES</div></div>
    </div>
  </div>
  <div class="tabs">
    <button class="tab active" onclick="showTab('misiones',this)">ğŸ¯ MISIONES</button>
    <button class="tab" onclick="showTab('ranking',this)">ğŸ† TOP</button>
    <button class="tab" onclick="showTab('referidos',this)">ğŸ¤ REFS</button>
    <button class="tab" onclick="showTab('juegos',this)">ğŸ® JUEGOS</button>
  </div>
</div>
<div class="tab-content active" id="tab-misiones">
  <div id="misLoad" class="loading"><div class="spinner"></div>Cargando...</div>
  <div id="misList" style="display:none"></div>
</div>
<div class="tab-content" id="tab-ranking">
  <div class="sec-title">TOP HOLDERS $PISK</div>
  <div id="rankList"><div class="loading"><div class="spinner"></div>Cargando...</div></div>
</div>
<div class="tab-content" id="tab-referidos">
  <div class="ref-box" style="text-align:center;padding:20px 16px;">
    <div style="font-size:10px;letter-spacing:3px;color:var(--muted);margin-bottom:6px">TU CÃ“DIGO DE REFERIDO</div>
    <div id="refCode" style="font-family:'Bebas Neue';font-size:34px;color:var(--gold2);letter-spacing:4px;margin-bottom:4px">â€”</div>
    <div style="font-size:11px;color:var(--muted);margin-bottom:16px">Comparte este cÃ³digo para ganar comisiones</div>
    <button class="btn-full btn-gold" onclick="compartir()" style="display:flex;align-items:center;justify-content:center;gap:8px;font-size:18px;">ğŸ“¤ COMPARTIR INVITACIÃ“N</button>
    <button onclick="copiarCodigo()" style="background:none;border:1px solid var(--border);color:var(--muted);padding:8px;width:100%;margin-top:8px;font-family:'Bebas Neue';font-size:13px;letter-spacing:2px;cursor:pointer;">ğŸ“‹ COPIAR SOLO EL CÃ“DIGO</button>
  </div>
  <div class="ref-stats" style="margin-bottom:12px;">
    <div class="ref-st"><div class="val" id="refTotal">0</div><div class="lbl">REFERIDOS</div></div>
    <div class="ref-st"><div class="val" id="refUsdt">$0.00</div><div class="lbl">USDT GANADO</div></div>
  </div>
  <div id="gateRefProgress" style="background:rgba(212,160,23,0.06);border:1px solid var(--border);padding:12px 16px;margin-bottom:12px;">
    <div style="display:flex;justify-content:space-between;font-size:11px;letter-spacing:2px;color:var(--muted);margin-bottom:6px;">
      <span>PERSONAS INVITADAS ESTE CICLO</span>
      <span id="gateRefCount" style="color:var(--gold2)">0/3</span>
    </div>
    <div style="height:6px;background:var(--dark3);border-radius:3px;overflow:hidden;">
      <div id="gateRefBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--gold),var(--green));border-radius:3px;transition:width 0.5s;"></div>
    </div>
    <div style="font-size:10px;color:var(--muted);margin-top:6px;">Necesitas 3 personas que digan "Hola" a Karla para seguir jugando cada 2 dÃ­as</div>
  </div>
  <div class="sec-title">MIS REFERIDOS</div>
  <div id="misReferidosList" style="margin-bottom:12px;"><div style="text-align:center;padding:16px;color:var(--muted);font-size:13px;">AÃºn no tienes referidos. Â¡Comparte tu cÃ³digo! ğŸš€</div></div>
  <div class="sec-title">COMISIONES POR INVERSIÃ“N</div>
  <div class="ref-levels">
    <div class="ref-lv"><div class="pct">10%</div><div class="lbl">NIVEL 1<br>DIRECTO</div></div>
    <div class="ref-lv"><div class="pct">3%</div><div class="lbl">NIVEL 2</div></div>
    <div class="ref-lv"><div class="pct">1%</div><div class="lbl">NIVEL 3</div></div>
  </div>
  <div style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:12px">50% USDT + 50% $PISK por cada inversiÃ³n</div>
  <div class="sec-title">BONOS POR VOLUMEN</div>
  <div id="bonosGrid"></div>
</div>
<div class="tab-content" id="tab-juegos">
  <div style="background:rgba(212,160,23,0.08);border:1px solid rgba(212,160,23,0.2);padding:14px 16px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;">
    <div>
      <div style="font-size:11px;letter-spacing:3px;color:var(--muted)">1,000 PTS = 1 $PISK</div>
      <div style="font-family:'Bebas Neue';font-size:13px;color:var(--muted)">Tienes: <span id="gPtsDisplay" style="color:var(--gold2)">0</span> puntos</div>
    </div>
    <button onclick="canjearPuntos()" id="gCanjeBtn" style="background:linear-gradient(135deg,var(--gold),#8B6914);color:var(--dark);border:none;padding:10px 20px;font-family:'Bebas Neue';font-size:16px;letter-spacing:2px;cursor:pointer;" disabled>CANJEAR</button>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
    <div class="mission-card" id="gc-tap" onclick="abrirJuego('tap')"><div class="m-icon">ğŸª™</div><div class="m-info"><div class="m-name">TAP COIN</div><div class="m-desc">Persigue la moneda 60 seg</div></div><div class="m-reward"><div class="m-pts">200</div><div class="m-lbl">PTS</div></div><div class="m-check" id="gcd-tap"></div></div>
    <div class="mission-card" id="gc-trivia" onclick="abrirJuego('trivia')"><div class="m-icon">ğŸ§ </div><div class="m-info"><div class="m-name">TRIVIA</div><div class="m-desc">4 preguntas $PISK</div></div><div class="m-reward"><div class="m-pts">100</div><div class="m-lbl">PTS</div></div><div class="m-check" id="gcd-trivia"></div></div>
    <div class="mission-card" id="gc-ruleta" onclick="abrirJuego('ruleta')"><div class="m-icon">ğŸ°</div><div class="m-info"><div class="m-name">RULETA</div><div class="m-desc">Gira y gana puntos</div></div><div class="m-reward"><div class="m-pts">300</div><div class="m-lbl">PTS</div></div><div class="m-check" id="gcd-ruleta"></div></div>
    <div class="mission-card" id="gc-changan" onclick="abrirJuego('changan')"><div class="m-icon">ğŸš—</div><div class="m-info"><div class="m-name">CHANGAN</div><div class="m-desc">Rompecabezas 4x4</div></div><div class="m-reward"><div class="m-pts">10</div><div class="m-lbl">PTS</div></div><div class="m-check" id="gcd-changan"></div></div>
    <div class="mission-card" id="gc-tetris" onclick="abrirJuego('tetris')" style="grid-column:1/-1;"><div class="m-icon">ğŸ®</div><div class="m-info"><div class="m-name">TETRIS PISK</div><div class="m-desc">Completa 6 lÃ­neas â†’ 500 pts</div></div><div class="m-reward"><div class="m-pts">500</div><div class="m-lbl">PTS</div></div><div class="m-check" id="gcd-tetris"></div></div>
  </div>
</div>

<!-- TAP -->
<div class="overlay" id="gov-tap">
  <div class="game-header"><div class="title">ğŸª™ TAP COIN</div><div class="score-item"><div class="score-val" id="tapScore">0</div><div class="score-lbl">PTS</div></div><div class="score-item"><div class="score-val" id="tapTimer">60</div><div class="score-lbl">SEG</div></div><button class="close-btn" onclick="cerrarJuego('tap')">âœ•</button></div>
  <div class="game-area" id="tapArea" style="position:relative;overflow:hidden;">
    <div id="tapCoin" onclick="doTap(event)" ontouchstart="doTap(event)" style="width:150px;height:150px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#F0C040,#D4A017,#5A3800);border:4px solid #D4A017;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 0 40px rgba(212,160,23,0.4);position:absolute;transition:left 0.4s ease,top 0.4s ease;"><span style="font-family:'Bebas Neue';font-size:48px;color:#07090C;">$</span></div>
    <div style="position:absolute;bottom:50px;left:16px;right:16px;"><div style="font-size:10px;color:var(--muted);letter-spacing:2px;margin-bottom:4px;">ENERGÃA</div><div style="height:8px;background:#1A2030;border-radius:4px;overflow:hidden;"><div id="energyFill" style="height:100%;width:100%;background:linear-gradient(90deg,var(--green),var(--gold));border-radius:4px;transition:width 0.1s;"></div></div></div>
  </div>
</div>

<!-- TRIVIA -->
<div class="overlay" id="gov-trivia">
  <div class="game-header"><div class="title">ğŸ§  TRIVIA $PISK</div><div class="score-item"><div class="score-val" id="triviaScore">0</div><div class="score-lbl">PTS</div></div><div class="score-item"><div class="score-val" id="triviaQ">1/4</div><div class="score-lbl">PREG</div></div><button class="close-btn" onclick="cerrarJuego('trivia')">âœ•</button></div>
  <div id="triviaDots" style="padding:8px 16px;background:var(--dark2);border-bottom:1px solid var(--border);display:flex;gap:4px;flex-shrink:0;"></div>
  <div class="game-area"><div style="padding:16px;width:100%;max-width:400px;"><div id="triviaQuestion" style="font-size:17px;font-weight:700;margin-bottom:20px;line-height:1.4;text-align:center;min-height:60px;"></div><div id="triviaOpts" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;"></div><div id="triviaFeedback" style="text-align:center;padding:12px;font-size:14px;margin-top:8px;min-height:40px;"></div></div></div>
</div>

<!-- RULETA -->
<div class="overlay" id="gov-ruleta">
  <div class="game-header"><div class="title">ğŸ° RULETA PISK</div><button class="close-btn" onclick="cerrarJuego('ruleta')">âœ•</button></div>
  <div class="game-area"><div style="display:flex;flex-direction:column;align-items:center;gap:20px;padding:16px;"><div style="position:relative;"><canvas id="ruletaCanvas" width="260" height="260" style="border-radius:50%;box-shadow:0 0 40px rgba(212,160,23,0.3);"></canvas><div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Bebas Neue';font-size:13px;color:var(--dark);background:var(--gold);padding:6px 8px;border-radius:50%;width:46px;height:46px;display:flex;align-items:center;justify-content:center;pointer-events:none;">$PISK</div><div style="position:absolute;top:-12px;left:50%;transform:translateX(-50%);font-size:22px;">â–¼</div></div><div id="ruletaResult" style="font-family:'Bebas Neue';font-size:28px;color:var(--gold2);text-align:center;min-height:40px;">Â¡Gira la ruleta!</div><button id="spinBtn" onclick="girarRuleta()" style="background:linear-gradient(135deg,var(--gold),#8B6914);color:var(--dark);border:none;padding:14px 40px;font-family:'Bebas Neue';font-size:22px;letter-spacing:3px;cursor:pointer;">ğŸ° GIRAR</button></div></div>
</div>

<!-- CHANGAN -->
<div class="overlay" id="gov-changan">
  <div class="game-header"><div class="title">ğŸš— CHANGAN</div><div class="score-item"><div class="score-val" id="changanMoves">0</div><div class="score-lbl">MOV</div></div><div class="score-item"><div class="score-val" id="changanTimer">120</div><div class="score-lbl">SEG</div></div><button class="close-btn" onclick="cerrarJuego('changan')">âœ•</button></div>
  <div class="game-area" style="flex-direction:column;gap:12px;padding:12px;"><div id="changanBoard" style="display:grid;grid-template-columns:repeat(4,1fr);gap:3px;width:100%;max-width:340px;margin:0 auto;"></div><div style="text-align:center;font-size:10px;color:var(--muted);letter-spacing:2px;">TOCA DOS PIEZAS PARA INTERCAMBIARLAS</div><button onclick="initChangan()" style="background:rgba(212,160,23,0.1);border:1px solid var(--border);color:var(--gold);padding:8px 20px;font-family:'Bebas Neue';font-size:14px;letter-spacing:2px;cursor:pointer;">â†» MEZCLAR</button></div>
</div>

<!-- TETRIS -->
<div class="overlay" id="gov-tetris">
  <div class="game-header"><div class="title">ğŸ® TETRIS PISK</div><div class="score-item"><div class="score-val" id="tetrisLines">0/6</div><div class="score-lbl">LÃNEAS</div></div><button class="close-btn" onclick="cerrarJuego('tetris')">âœ•</button></div>
  <div style="font-family:'Bebas Neue';font-size:12px;letter-spacing:2px;color:var(--muted);text-align:center;padding:4px;flex-shrink:0;">Completa 6 lÃ­neas â†’ 500 pts ğŸ’</div>
  <div class="game-area" style="flex-direction:column;gap:8px;padding:8px 0;"><canvas id="tetrisCanvas"></canvas></div>
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:8px 16px;flex-shrink:0;">
    <button onclick="tetrisMove(-1)" style="background:var(--dark3);border:1px solid var(--border);color:var(--text);padding:14px;font-size:20px;cursor:pointer;">â—€</button>
    <button onclick="tetrisRotate()" style="background:var(--dark3);border:1px solid var(--border);color:var(--text);padding:14px;font-size:20px;cursor:pointer;">ğŸ”„</button>
    <button onclick="tetrisMove(1)" style="background:var(--dark3);border:1px solid var(--border);color:var(--text);padding:14px;font-size:20px;cursor:pointer;">â–¶</button>
    <button onclick="tetrisDrop()" style="grid-column:1/-1;background:var(--dark3);border:1px solid var(--border);color:var(--text);padding:14px;font-size:16px;cursor:pointer;">â¬‡ BAJAR</button>
  </div>
</div>

<!-- RESULT -->
<div id="gameResult" style="display:none;position:fixed;inset:0;background:rgba(7,9,12,0.96);z-index:400;flex-direction:column;align-items:center;justify-content:center;gap:16px;">
  <div id="grIcon" style="font-size:64px;"></div>
  <div style="font-family:'Bebas Neue';font-size:36px;letter-spacing:4px;color:var(--gold);">Â¡GANASTE!</div>
  <div id="grPts" style="font-family:'Bebas Neue';font-size:56px;color:var(--gold2);line-height:1;"></div>
  <div style="font-size:13px;color:var(--muted);letter-spacing:2px;">PUNTOS GANADOS</div>
  <button id="grBtn" style="background:linear-gradient(135deg,var(--gold),#8B6914);color:var(--dark);border:none;padding:14px 36px;font-family:'Bebas Neue';font-size:20px;letter-spacing:3px;cursor:pointer;margin-top:8px;">COBRAR Y SALIR</button>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
  <div class="modal" id="modal"><div class="modal-handle"></div><div id="modalContent"></div></div>
</div>

<script>
const API = 'http://69.169.109.120/airdrop-api';
const TP  = 0.10;
const tg  = window.Telegram?.WebApp;
let user  = null;
let lang  = 'es';

const TX = {
  es: {
    sec: 'MISIONES DISPONIBLES', done: 'âœ“', claim: 'RECLAMAR', cancel: 'CANCELAR', send: 'ENVIAR',
    m: [
      {id:'registro',  icon:'ğŸ“', n:'Registro Completo',    d:'Completa tu perfil y recibe tokens',            r:5,   a:'form'},
      {id:'viral',     icon:'ğŸ¦ ', n:'MisiÃ³n Viral 5x5',     d:'Invita 5 amigos a Karla por WS o Telegram',     r:20,  a:'viral'},
      {id:'redes',     icon:'ğŸ“±', n:'Seguir Redes',         d:'Sigue TikTok, X, Telegram y YouTube',           r:10,  a:'redes'},
      {id:'voucher',   icon:'ğŸ’°', n:'Voucher InversiÃ³n',    d:'Compra $PISK y sube tu comprobante',            r:250, a:'upload'},
      {id:'influencer',icon:'ğŸ¬', n:'MisiÃ³n Influencer',    d:'Publica video en TikTok/Reels sobre $PISK',     r:40,  a:'link'},
      {id:'comunidad', icon:'ğŸ‘¥', n:'Unirse Comunidad',     d:'Ãšnete al grupo oficial de Telegram',            r:10,  a:'comunidad'},
      {id:'wallet',    icon:'ğŸ’³', n:'Registrar Wallet',     d:'Registra tu wallet USDT (BEP20/TRC20)',         r:5,   a:'wallet'},
      {id:'humanidad', icon:'ğŸ¤–', n:'Prueba Humanidad',     d:'Demuestra que no eres un bot',                  r:5,   a:'captcha'},
      {id:'diario',    icon:'ğŸ”¥', n:'Fidelidad Diaria',     d:'Reclama +1 $PISK cada 24 horas',               r:1,   a:'diario'},
    ]
  },
  en: {
    sec:'AVAILABLE MISSIONS', done:'âœ“', claim:'CLAIM', cancel:'CANCEL', send:'SEND',
    m:[
      {id:'registro',  icon:'ğŸ“', n:'Full Registration',   d:'Complete your profile and earn tokens',         r:5,   a:'form'},
      {id:'viral',     icon:'ğŸ¦ ', n:'Viral 5x5 Mission',   d:'Invite 5 friends to Karla on WS or Telegram',   r:20,  a:'viral'},
      {id:'redes',     icon:'ğŸ“±', n:'Follow Social Media', d:'Follow TikTok, X, Telegram and YouTube',        r:10,  a:'redes'},
      {id:'voucher',   icon:'ğŸ’°', n:'Investment Voucher',  d:'Buy $PISK and upload your receipt',             r:250, a:'upload'},
      {id:'influencer',icon:'ğŸ¬', n:'Influencer Mission',  d:'Post a TikTok/Reels video about $PISK',         r:40,  a:'link'},
      {id:'comunidad', icon:'ğŸ‘¥', n:'Join Community',      d:'Join the official Telegram group',              r:10,  a:'comunidad'},
      {id:'wallet',    icon:'ğŸ’³', n:'Register Wallet',     d:'Register your USDT wallet (BEP20/TRC20)',       r:5,   a:'wallet'},
      {id:'humanidad', icon:'ğŸ¤–', n:'Humanity Proof',      d:'Prove you are not a bot',                       r:5,   a:'captcha'},
      {id:'diario',    icon:'ğŸ”¥', n:'Daily Loyalty',       d:'Claim +1 $PISK every 24 hours',                r:1,   a:'diario'},
    ]
  },
  pt: {
    sec:'MISSÃ•ES DISPONÃVEIS', done:'âœ“', claim:'RESGATAR', cancel:'CANCELAR', send:'ENVIAR',
    m:[
      {id:'registro',  icon:'ğŸ“', n:'Registro Completo',   d:'Complete seu perfil e ganhe tokens',            r:5,   a:'form'},
      {id:'viral',     icon:'ğŸ¦ ', n:'MissÃ£o Viral 5x5',    d:'Convide 5 amigos para Karla no WS ou Telegram', r:20,  a:'viral'},
      {id:'redes',     icon:'ğŸ“±', n:'Seguir Redes',        d:'Siga TikTok, X, Telegram e YouTube',            r:10,  a:'redes'},
      {id:'voucher',   icon:'ğŸ’°', n:'Comprovante',         d:'Compre $PISK e envie seu comprovante',          r:250, a:'upload'},
      {id:'influencer',icon:'ğŸ¬', n:'MissÃ£o Influencer',   d:'Publique vÃ­deo no TikTok/Reels sobre $PISK',    r:40,  a:'link'},
      {id:'comunidad', icon:'ğŸ‘¥', n:'Entrar Comunidade',   d:'Entre no grupo oficial do Telegram',            r:10,  a:'comunidad'},
      {id:'wallet',    icon:'ğŸ’³', n:'Registrar Carteira',  d:'Registre sua carteira USDT (BEP20/TRC20)',      r:5,   a:'wallet'},
      {id:'humanidade',icon:'ğŸ¤–', n:'Prova Humanidade',    d:'Prove que vocÃª nÃ£o Ã© um bot',                   r:5,   a:'captcha'},
      {id:'diario',    icon:'ğŸ”¥', n:'Fidelidade DiÃ¡ria',   d:'Resgate +1 $PISK a cada 24 horas',             r:1,   a:'diario'},
    ]
  }
};

window.addEventListener('load', async () => {
  if (tg) { tg.ready(); tg.expand(); tg.setHeaderColor('#07090C'); tg.setBackgroundColor('#07090C'); }
  const tgUser = tg?.initDataUnsafe?.user;
  const uid    = tgUser?.id || 'demo_' + Math.random().toString(36).slice(2,8);
  const nombre = tgUser?.first_name || 'Amigo';
  document.getElementById('userAvatar').textContent = nombre.charAt(0).toUpperCase();
  document.getElementById('userName').textContent   = nombre;
  await cargarUsuario(uid, nombre);
  renderMisiones();
  cargarRanking();
});

async function cargarUsuario(uid, nombre) {
  const local = loadUserLocal(uid);
  if (local) { user=local; lang=user.idioma||'es'; document.getElementById('langSelect').value=lang; updateUI(); renderMisiones(); }
  try {
    const r = await fetch(`${API}/usuario?id=${uid}&nombre=${encodeURIComponent(nombre)}`,{signal:AbortSignal.timeout(5000)});
    const remoto = await r.json();
    if (local) { remoto.pisk_balance=Math.max(remoto.pisk_balance||0,local.pisk_balance||0); remoto.misiones=Object.assign({},remoto.misiones||{},local.misiones||{}); remoto.wallet=remoto.wallet||local.wallet; }
    user = remoto;
  } catch(e) {
    if (!user) user={id:uid,nombre,idioma:'es',pisk_balance:0,usdt_pendiente:0,codigo_ref:'PISK'+String(uid).slice(-6),mis_referidos:[],misiones:{}};
  }
  lang=user.idioma||'es'; document.getElementById('langSelect').value=lang; updateUI(); renderMisiones();
}

function saveUserLocal() { if(!user)return; try{localStorage.setItem('pisk_user_'+(user.id||'demo'),JSON.stringify(user));}catch(e){} }
function loadUserLocal(uid) { try{const s=localStorage.getItem('pisk_user_'+uid);return s?JSON.parse(s):null;}catch(e){return null;} }

function updateUI() {
  if(!user)return; saveUserLocal();
  document.getElementById('balAmt').textContent  = user.pisk_balance||0;
  document.getElementById('balUsd').textContent  = `â‰ˆ $${((user.pisk_balance||0)*TP).toFixed(2)} USD`;
  document.getElementById('balUsdt').textContent = `$${(user.usdt_pendiente||0).toFixed(2)}`;
  document.getElementById('balRefs').textContent = (user.mis_referidos||[]).length;
  const done=Object.values(user.misiones||{}).filter(Boolean).length;
  document.getElementById('balMis').textContent  = `${done}/9`;
  document.getElementById('refCode').textContent = user.codigo_ref||'â€”';
  document.getElementById('refTotal').textContent= (user.mis_referidos||[]).length;
  document.getElementById('refUsdt').textContent = `$${(user.usdt_pendiente||0).toFixed(2)}`;
  document.getElementById('userCode').textContent= 'CÃ“DIGO: '+(user.codigo_ref||'â€”');
  renderMisReferidos();
  const refs=(user.mis_referidos||[]).length;
  document.getElementById('bonosGrid').innerHTML=[{n:5,u:5},{n:10,u:15},{n:25,u:50},{n:50,u:100}].map(b=>`
    <div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--dark3);border:1px solid ${refs>=b.n?'var(--green)':'var(--border)'};margin-bottom:6px;">
      <span>${refs>=b.n?'âœ…':'ğŸ”’'}</span><div style="flex:1"><strong>${b.n} referidos</strong><br><span style="font-size:10px;color:var(--muted)">+$${b.u} USDT</span></div>
      <span style="font-family:'Bebas Neue';font-size:18px;color:${refs>=b.n?'var(--green)':'var(--muted)'}">$${b.u}</span></div>`).join('');
}

function renderMisiones() {
  const t=TX[lang];
  document.getElementById('misLoad').style.display='none';
  const el=document.getElementById('misList'); el.style.display='block';
  el.innerHTML=`<div class="sec-title">${t.sec}</div>`+t.m.map(m=>{
    const done=user?.misiones?.[m.id];
    return `<div class="mission-card${done?' done':''}" onclick="${done?'':('openM(\''+m.id+'\')')}">
      <div class="m-icon">${m.icon}</div><div class="m-info"><div class="m-name">${m.n}</div><div class="m-desc">${m.d}</div></div>
      <div class="m-reward"><div class="m-pts">+${m.r}</div><div class="m-lbl">$PISK</div></div>
      <div class="m-check${done?' done':''}">${done?'âœ“':''}</div></div>`;
  }).join('');
}

async function cargarRanking() {
  try {
    const r=await fetch(`${API}/ranking`); const d=await r.json();
    document.getElementById('rankList').innerHTML=(d.top||[]).map((u,i)=>`
      <div class="rank-item"><div class="rank-n ${i<3?'rk'+(i+1):'rkn'}">${i+1}</div><div class="rank-av">${u.nombre.charAt(0)}</div>
      <div class="rank-info"><div class="rank-name">${u.nombre}</div><div class="rank-sub">${u.refs} refs</div></div>
      <div class="rank-pisk">${u.pisk}</div></div>`).join('')||'<div style="color:var(--muted);text-align:center;padding:20px">Sin datos aÃºn</div>';
  } catch(e){}
}

function openM(id) {
  const t=TX[lang]; const m=t.m.find(x=>x.id===id); if(!m)return;
  let html=`<div class="modal-title">${m.icon} ${m.n}</div><div class="modal-reward"><div><div class="modal-pts">+${m.r} $PISK</div><div class="modal-pts-sub">â‰ˆ $${(m.r*TP).toFixed(2)} USD</div></div></div>`;
  if(m.a==='form') html+=`<input class="m-input" id="iNombre" placeholder="Nombre completo"><input class="m-input" id="iPais" placeholder="PaÃ­s"><button class="btn-full btn-gold" onclick="doMision('registro')">${t.claim}</button>`;
  else if(m.a==='viral') html+=`<div class="modal-desc">Invita 5 amigos. Deben saludar a Karla con tu cÃ³digo en WhatsApp o Telegram.</div>
    <a class="social-row" href="https://wa.me/51948115030" target="_blank"><span class="si">ğŸ’¬</span><div><div class="sn">WhatsApp</div><div class="su">wa.me/51948115030</div></div></a>
    <a class="social-row" href="https://t.me/NeoPisk_bot" target="_blank"><span class="si">âœˆï¸</span><div><div class="sn">Telegram</div><div class="su">t.me/NeoPisk_bot</div></div></a>
    <button class="btn-full btn-gold" onclick="doMision('viral')">${t.claim} (${(user?.mis_referidos||[]).length}/5)</button>`;
  else if(m.a==='redes') html+=`<div class="modal-desc">Sigue todas las redes para recibir tu recompensa.</div>
    <a class="social-row" href="https://www.tiktok.com/@ernestopiskulich" target="_blank"><span class="si">ğŸµ</span><div><div class="sn">TikTok</div></div></a>
    <a class="social-row" href="https://x.com/EPiskulich50437" target="_blank"><span class="si">ğŸ¦</span><div><div class="sn">Twitter / X</div></div></a>
    <a class="social-row" href="https://t.me/NeoPisk_bot" target="_blank"><span class="si">âœˆï¸</span><div><div class="sn">Telegram</div></div></a>
    <a class="social-row" href="https://youtube.com/@neopisk" target="_blank"><span class="si">â–¶ï¸</span><div><div class="sn">YouTube</div></div></a>
    <button class="btn-full btn-gold" onclick="doMision('redes')">${t.claim}</button>`;
  else if(m.a==='upload') html+=`<div class="modal-desc">Compra tokens $PISK y sube tu comprobante.</div>
    <div style="padding:10px;background:var(--dark3);border:1px solid var(--border);font-size:12px;margin-bottom:10px">ğŸ’³ Yape: 51948115030<br>ğŸŒ <a href="https://neopisk.lat/invertir.html" style="color:var(--gold)">neopisk.lat/invertir.html</a></div>
    <input type="file" id="vFile" accept="image/*" style="display:none" onchange="subirVoucher()">
    <button class="btn-full btn-gold" onclick="document.getElementById('vFile').click()">ğŸ“· SUBIR COMPROBANTE</button>`;
  else if(m.a==='link') html+=`<input class="m-input" id="iVideo" placeholder="https://tiktok.com/..."><button class="btn-full btn-gold" onclick="enviarVideo()">${t.send}</button>`;
  else if(m.a==='comunidad') html+=`<div class="modal-desc">Ãšnete al grupo oficial y confirma.</div>
    <a class="social-row" href="https://t.me/NeoPisk_bot" target="_blank"><span class="si">âœˆï¸</span><div><div class="sn">Abrir Telegram</div></div></a>
    <button class="btn-full btn-gold" onclick="doMision('comunidad')">${t.claim}</button>`;
  else if(m.a==='wallet') html+=`<input class="m-input" id="iWallet" placeholder="0x... o TRC20..."><button class="btn-full btn-gold" onclick="guardarWallet()">${t.claim}</button>`;
  else if(m.a==='captcha') html+=`<div style="font-size:22px;text-align:center;padding:14px;background:var(--dark3);margin-bottom:10px">Â¿CuÃ¡nto es <strong>7 Ã— 8</strong>?</div><input class="m-input" id="iCaptcha" type="number" placeholder="Respuesta"><button class="btn-full btn-gold" onclick="checkCaptcha()">${t.claim}</button>`;
  else if(m.a==='diario') html+=`<div class="modal-desc">Reclama tu recompensa diaria. Vuelve maÃ±ana.</div><button class="btn-full btn-gold" onclick="doMision('diario')">${t.claim} +1 $PISK</button>`;
  html+=`<button class="btn-full btn-ghost" onclick="closeModal()">${t.cancel}</button>`;
  document.getElementById('modalContent').innerHTML=html;
  document.getElementById('modalOverlay').classList.add('show');
}

async function doMision(id) {
  if(id==='diario'){
    const key='diario_'+(user?.id||'demo'); const ultimo=localStorage.getItem(key); const ahora=Date.now();
    if(ultimo&&(ahora-parseInt(ultimo))<23*60*60*1000){toast('â° Vuelve en '+Math.ceil((23*60*60*1000-(ahora-parseInt(ultimo)))/3600000)+' horas');return;}
    localStorage.setItem(key,ahora); if(!user.misiones)user.misiones={};
    user.misiones['diario']=true; user.pisk_balance=(user.pisk_balance||0)+1;
    closeModal();updateUI();renderMisiones();toast('ğŸ‰ +1 $PISK reclamado!');tg?.HapticFeedback?.notificationOccurred('success');return;
  }
  if(id==='humanidad'){
    if(!user.misiones)user.misiones={};
    user.misiones['humanidad']=true; user.pisk_balance=(user.pisk_balance||0)+5;
    closeModal();updateUI();renderMisiones();toast('ğŸ‰ +5 $PISK ganados!');tg?.HapticFeedback?.notificationOccurred('success');return;
  }
  const body={userId:user.id,mision:id};
  if(id==='registro'){body.nombre=document.getElementById('iNombre')?.value;body.pais=document.getElementById('iPais')?.value;if(!body.nombre||!body.pais){toast('âš ï¸ Completa los campos');return;}}
  if(id==='wallet'){
    const w=document.getElementById('iWallet')?.value?.trim();
    if(!w||w.length<20){toast('âš ï¸ Wallet invÃ¡lida');return;}
    body.wallet=w; if(!user.misiones)user.misiones={};
    if(!user.misiones['wallet']){user.wallet=w;user.misiones['wallet']=true;user.pisk_balance=(user.pisk_balance||0)+5;closeModal();updateUI();renderMisiones();toast('ğŸ‰ +5 $PISK! Wallet guardada');tg?.HapticFeedback?.notificationOccurred('success');fetch(`${API}/mision`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).catch(()=>{});}
    else{toast('âš ï¸ Wallet ya registrada');closeModal();}return;
  }
  const REWARDS_LOCAL={registro:5,viral:20,redes:10,comunidad:10,humanidad:5,diario:1};
  try {
    const r=await fetch(`${API}/mision`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body),signal:AbortSignal.timeout(6000)});
    const d=await r.json();
    if(d.ok){user=d.usuario;closeModal();updateUI();renderMisiones();toast(`ğŸ‰ +${d.tokens} $PISK!`);tg?.HapticFeedback?.notificationOccurred('success');}
    else toast('âŒ '+(d.error||'Error'));
  } catch(e){
    if(REWARDS_LOCAL[id]!==undefined&&!user.misiones?.[id]){
      if(!user.misiones)user.misiones={};
      user.misiones[id]=true;user.pisk_balance=(user.pisk_balance||0)+REWARDS_LOCAL[id];
      closeModal();updateUI();renderMisiones();toast('ğŸ‰ +'+REWARDS_LOCAL[id]+' $PISK!');tg?.HapticFeedback?.notificationOccurred('success');
    } else {toast('âš ï¸ Sin conexiÃ³n.');closeModal();}
  }
}

function checkCaptcha(){parseInt(document.getElementById('iCaptcha')?.value)===56?doMision('humanidad'):toast('âŒ Incorrecto');}
async function guardarWallet(){const w=document.getElementById('iWallet')?.value?.trim();if(!w||w.length<20){toast('âš ï¸ Wallet invÃ¡lida');return;}doMision('wallet');}
async function enviarVideo(){const l=document.getElementById('iVideo')?.value?.trim();if(!l||!l.startsWith('http')){toast('âš ï¸ Link invÃ¡lido');return;}try{await fetch(`${API}/video-link`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user.id,link:l})});closeModal();toast('âœ… Enviado al admin');}catch(e){toast('âŒ Error');}}
async function subirVoucher(){const f=document.getElementById('vFile').files[0];if(!f)return;const fd=new FormData();fd.append('voucher',f);fd.append('userId',user.id);try{await fetch(`${API}/voucher`,{method:'POST',body:fd});closeModal();toast('âœ… Comprobante enviado');}catch(e){toast('âŒ Error');}}

function copiarCodigo(){
  const codigo=user?.codigo_ref||'â€”';
  if(navigator.clipboard){navigator.clipboard.writeText(codigo).then(()=>toast('ğŸ“‹ CÃ³digo copiado: '+codigo));}
  else{const el=document.createElement('input');el.value=codigo;document.body.appendChild(el);el.select();document.execCommand('copy');document.body.removeChild(el);toast('ğŸ“‹ CÃ³digo copiado: '+codigo);}
}

function renderMisReferidos(){
  const refs=user?.mis_referidos||[]; const el=document.getElementById('misReferidosList'); if(!el)return;
  const count=Math.min(refs.length,3);
  const gateEl=document.getElementById('gateRefCount'); const gateBar=document.getElementById('gateRefBar');
  if(gateEl)gateEl.textContent=count+'/3'; if(gateBar)gateBar.style.width=(count/3*100)+'%';
  if(refs.length===0){el.innerHTML='<div style="text-align:center;padding:16px;color:var(--muted);font-size:13px;">AÃºn no tienes referidos. Â¡Comparte tu cÃ³digo! ğŸš€</div>';return;}
  el.innerHTML=refs.slice(0,10).map((r,i)=>{
    const nombre=typeof r==='object'?r.nombre:'Usuario #'+(i+1); const pisk=typeof r==='object'?(r.pisk||0):0;
    return '<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--dark3);border:1px solid var(--border);margin-bottom:4px;">'+
      '<div style="display:flex;align-items:center;gap:10px;"><div style="width:32px;height:32px;border-radius:50%;background:rgba(212,160,23,0.15);display:flex;align-items:center;justify-content:center;font-size:14px;">ğŸ‘¤</div>'+
      '<div><div style="font-weight:700;font-size:13px;">'+nombre+'</div><div style="font-size:10px;color:var(--muted);">NIVEL 1 DIRECTO</div></div></div>'+
      '<div style="text-align:right;"><div style="font-family:Bebas Neue;font-size:14px;color:var(--gold2);">'+pisk+' $PISK</div><div style="font-size:10px;color:var(--green);">âœ… Activo</div></div></div>';
  }).join('')+(refs.length>10?'<div style="text-align:center;padding:8px;color:var(--muted);font-size:12px;">+' + (refs.length-10) + ' mÃ¡s...</div>':'');
}

// â•â• COMPARTIR â€” incluye link de compra con cÃ³digo del promotor â•â•
function compartir(){
  const codigo = user?.codigo_ref || 'PISK000000';
  const uid    = user?.id || '';
  const txt =
    'ğŸš€ Â¡Ãšnete al Airdrop Global $PISK y gana tokens reales!\n\n' +
    'ğŸ’ Token respaldado por flota elÃ©ctrica y robÃ³tica en PerÃº.\n' +
    'Precio de preventa: $0.10 USD\n\n' +
    'ğŸ® Gana $PISK jugando mini juegos\n' +
    'ğŸ¤ Comisiones por referidos: 10% + 3% + 1%\n\n' +
    'ğŸ“² Ãšnete al Airdrop:\n' +
    'âœˆï¸ https://t.me/NeoPisk_bot\n\n' +
    'ğŸ›’ Compra $PISK directo:\n' +
    'https://neopisk.lat/comprar.html?ref=' + codigo + '&uid=' + uid + '\n\n' +
    'ğŸ”‘ Mi cÃ³digo: ' + codigo;

  if(tg?.openTelegramLink){const enc=encodeURIComponent(txt);tg.openTelegramLink('https://t.me/share/url?url=https://t.me/NeoPisk_bot&text='+enc);return;}
  if(navigator.share){navigator.share({title:'Airdrop $PISK',text:txt});return;}
  if(navigator.clipboard){navigator.clipboard.writeText(txt).then(()=>toast('ğŸ“‹ Â¡Mensaje copiado!'));return;}
  const el=document.createElement('textarea');el.value=txt;document.body.appendChild(el);el.select();document.execCommand('copy');document.body.removeChild(el);toast('ğŸ“‹ Â¡Copiado!');
}

function showTab(tab,btn){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.getElementById('tab-'+tab).classList.add('active');btn.classList.add('active');if(tab==='ranking')cargarRanking();}
function closeModal(e){if(e&&e.target!==document.getElementById('modalOverlay'))return;document.getElementById('modalOverlay').classList.remove('show');}
function cambiarIdioma(l){lang=l;if(user)user.idioma=l;renderMisiones();updateUI();}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}

// â”€â”€ GAME STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const gState={pts:0,cooldowns:{},firstPlay:null};
const CD_24H=24*60*60*1000, PPK=1000;

function loadGameState(){const uid=user?.id||'demo';try{const s=localStorage.getItem('pg_'+uid);if(s)Object.assign(gState,JSON.parse(s));}catch(e){}updateGameUI();updateGameCooldowns();}
function saveGameState(){const uid=user?.id||'demo';try{localStorage.setItem('pg_'+uid,JSON.stringify(gState));}catch(e){}}
function addGamePts(pts){gState.pts+=pts;saveGameState();updateGameUI();}

function updateGameUI(){
  const el=document.getElementById('gPtsDisplay'); const btn=document.getElementById('gCanjeBtn');
  if(el)el.textContent=gState.pts.toLocaleString();
  if(btn){
    const balance=user?.pisk_balance||0, ext=balance-contarPiskMisionesSimple(), bloqueado=balance<10||ext<2;
    btn.disabled=gState.pts<PPK||bloqueado;
    if(gState.pts>=PPK&&bloqueado){btn.textContent='ğŸ”’ BLOQUEADO';btn.style.background='rgba(255,61,61,0.2)';btn.style.color='#FF3D3D';}
    else if(gState.pts>=PPK){btn.textContent='CANJEAR';btn.style.background='linear-gradient(135deg,var(--gold),#8B6914)';btn.style.color='var(--dark)';}
  }
}

function updateGameCooldowns(){
  ['tap','trivia','ruleta','changan','tetris'].forEach(g=>{
    const el=document.getElementById('gcd-'+g); const card=document.getElementById('gc-'+g); if(!el||!card)return;
    const cd=gState.cooldowns[g];
    if(cd&&(Date.now()-cd)<CD_24H){const rem=CD_24H-(Date.now()-cd);el.textContent='â°';el.style.color='#FF3D3D';card.style.opacity='0.5';card.style.cursor='default';}
    else{el.textContent='âœ…';el.style.color='var(--green)';card.style.opacity='1';card.style.cursor='pointer';}
  });
}

function isGameLocked(g){const cd=gState.cooldowns[g];return cd&&(Date.now()-cd)<CD_24H;}

function abrirJuego(g){
  if(isGameLocked(g)){toast('â° Disponible en 24 horas');return;}
  if(!gState.firstPlay){gState.firstPlay=Date.now();saveGameState();}
  const ov=document.getElementById('gov-'+g); if(!ov)return;
  ov.classList.add('show');
  if(g==='tap'){tapRunning=false;clearInterval(window.coinMoveInt);clearInterval(window['gi_tap']);initTap();}
  if(g==='trivia')initTrivia(); if(g==='ruleta')initRuleta(); if(g==='changan')initChangan(); if(g==='tetris')initTetris();
}

function cerrarJuego(g){
  const ov=document.getElementById('gov-'+g); if(ov)ov.classList.remove('show');
  clearInterval(window['gi_'+g]);
  if(g==='tap'){clearInterval(window.coinMoveInt);tapRunning=false;}
  if(g==='tetris'&&window.tetrisLoop){clearInterval(window.tetrisLoop);window.tetrisLoop=null;}
  document.getElementById('gameResult').style.display='none';
}

function showGameResult(g,pts,icon){
  cerrarJuego(g); const rd=document.getElementById('gameResult');
  document.getElementById('grIcon').textContent=icon||'ğŸ†';
  document.getElementById('grPts').textContent='+'+pts;
  document.getElementById('grBtn').onclick=()=>{
    addGamePts(pts); gState.cooldowns[g]=Date.now(); saveGameState(); updateGameCooldowns();
    rd.style.display='none'; toast('ğŸ‰ +'+pts+' puntos!'); tg?.HapticFeedback?.notificationOccurred('success');
  };
  rd.style.display='flex';
}

function canjearPuntos(){
  const pisk=Math.floor(gState.pts/PPK); if(pisk<1)return;
  const balance=user?.pisk_balance||0, piskMis=contarPiskMisiones(), ext=balance-piskMis;
  if(balance<10){showLockModal('ğŸ”’ Te faltan '+(10-balance)+' $PISK.\n\nNecesitas 2 $PISK de:\nâ€¢ Traer un referido que compre\nâ€¢ Comprar $PISK con MetaMask');return;}
  if(ext<2){showLockModal('ğŸ”’ Â¡Casi listo!\n\nNecesitas al menos 2 $PISK de:\nâ€¢ ğŸ¤ Traer un referido que compre\nâ€¢ ğŸ¦Š Comprar $PISK con MetaMask');return;}
  gState.pts-=pisk*PPK;saveGameState();updateGameUI();
  if(user){user.pisk_balance=(user.pisk_balance||0)+pisk;updateUI();}
  fetch(API+'/canjear-puntos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:user?.id,puntos:pisk*PPK,pisk})}).catch(()=>{});
  toast('ğŸ‰ Â¡+'+pisk+' $PISK canjeados!'); tg?.HapticFeedback?.notificationOccurred('success');
}

function contarPiskMisionesSimple(){return user?contarPiskMisiones():0;}
function contarPiskMisiones(){
  const mis=user?.misiones||{}, rw={registro:5,viral:20,redes:10,comunidad:10,humanidad:5,diario:1,wallet:5};
  let t=0; Object.entries(mis).forEach(([k,v])=>{if(v&&rw[k])t+=rw[k];}); return Math.min(t,8);
}

function showLockModal(msg){
  const ov=document.getElementById('lockOverlay');
  if(!ov){
    const div=document.createElement('div'); div.id='lockOverlay';
    div.style.cssText='position:fixed;inset:0;background:rgba(7,9,12,0.95);z-index:500;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;';
    div.innerHTML=`<div style="font-size:48px;margin-bottom:16px;">ğŸ”’</div>
      <div style="font-family:'Bebas Neue';font-size:22px;letter-spacing:3px;color:#D4A017;margin-bottom:12px;">CANJE BLOQUEADO</div>
      <div id="lockMsg" style="font-size:14px;color:#E8EDF5;text-align:center;line-height:1.6;margin-bottom:20px;max-width:300px;white-space:pre-line;">${msg}</div>
      <button onclick="document.getElementById('lockOverlay').style.display='none'" style="background:linear-gradient(135deg,#D4A017,#8B6914);color:#07090C;border:none;padding:14px 32px;font-family:'Bebas Neue';font-size:18px;letter-spacing:3px;cursor:pointer;width:100%;max-width:300px;">ENTENDIDO</button>
      <div style="margin-top:12px;font-size:11px;color:#5A6A7A;text-align:center;">Trae un amigo que compre o compra tÃº mismo</div>`;
    document.body.appendChild(div);
  } else { document.getElementById('lockMsg').textContent=msg; ov.style.display='flex'; }
  tg?.HapticFeedback?.notificationOccurred('error');
}

// â”€â”€ TAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tapScore=0,tapEnergy=200,tapRunning=false;
function initTap(){tapScore=0;tapEnergy=200;tapRunning=true;document.getElementById('tapScore').textContent=0;document.getElementById('tapTimer').textContent=60;document.getElementById('energyFill').style.width='100%';moveTapCoin();window.coinMoveInt=setInterval(moveTapCoin,1200);let t=60;window['gi_tap']=setInterval(()=>{t--;document.getElementById('tapTimer').textContent=t;tapEnergy=Math.min(200,tapEnergy+2);document.getElementById('energyFill').style.width=(tapEnergy/200*100)+'%';if(t<=0){clearInterval(window['gi_tap']);clearInterval(window.coinMoveInt);tapRunning=false;showGameResult('tap',tapScore,'ğŸª™');}},1000);}
function moveTapCoin(){const coin=document.getElementById('tapCoin');const area=document.getElementById('tapArea');if(!coin||!area)return;const aW=area.clientWidth,aH=area.clientHeight,m=20;coin.style.left=m+Math.random()*(aW-150-m*2)+'px';coin.style.top=m+Math.random()*(aH-150-m*2-80)+'px';}
function doTap(e){e.stopPropagation();if(!tapRunning||tapEnergy<=0)return;tapEnergy=Math.max(0,tapEnergy-1);tapScore++;document.getElementById('tapScore').textContent=tapScore;document.getElementById('energyFill').style.width=(tapEnergy/200*100)+'%';setTimeout(moveTapCoin,150);const coin=document.getElementById('tapCoin');const area=document.getElementById('tapArea');const cr=coin.getBoundingClientRect(),ar=area.getBoundingClientRect();const sp=document.createElement('span');sp.style.cssText='position:absolute;font-family:Bebas Neue,sans-serif;font-size:24px;color:#F0C040;pointer-events:none;animation:floatUp 0.8s ease forwards;left:'+(cr.left-ar.left+cr.width/2)+'px;top:'+(cr.top-ar.top)+'px;';sp.textContent='+1';area.appendChild(sp);setTimeout(()=>sp.remove(),800);tg?.HapticFeedback?.impactOccurred('light');}

// â”€â”€ TRIVIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TPOOL=[{q:'Â¿Precio de preventa del token $PISK?',opts:['$0.05','$0.10','$0.25','$1.00'],a:1},{q:'Â¿QuÃ© vehÃ­culos usa Neo Pisk en su flota?',opts:['Gasolina','HÃ­bridos','ElÃ©ctricos','DiÃ©sel'],a:2},{q:'Â¿En quÃ© red se compra $PISK con USDT?',opts:['Ethereum','Polygon','Bitcoin','Solana'],a:1},{q:'Â¿1,000 puntos equivalen a cuÃ¡ntos $PISK?',opts:['10 $PISK','5 $PISK','1 $PISK','0.1 $PISK'],a:2},{q:'Â¿QuÃ© marca de auto usa Neo Pisk?',opts:['Tesla','BYD/Changan','Rivian','Nio'],a:1},{q:'Â¿ComisiÃ³n de referido Nivel 1?',opts:['5%','7%','10%','15%'],a:2},{q:'Â¿Plataformas ride-sharing de Neo Pisk?',opts:['Uber y Cabify','Yango e InDriver','Solo Uber','Ninguna'],a:1},{q:'Â¿Mecanismo que sube el valor de $PISK?',opts:['MinerÃ­a','Buyback & Burn','Solo staking','InflaciÃ³n'],a:1},{q:'Â¿SÃ­mbolo del token de Neo Pisk?',opts:['$NEO','$PISK','$NPTK','$ELEC'],a:1},{q:'Â¿QuÃ© ofrece Neo Pisk ademÃ¡s de tokens?',opts:['MinerÃ­a BTC','RobÃ³tica e IA','Turismo','NFT arte'],a:1}];
let TQS=[],tIdx=0,tScore=0,tAnswered=false;
function initTrivia(){tIdx=0;tScore=0;tAnswered=false;TQS=[...TPOOL].sort(()=>Math.random()-0.5).slice(0,4);document.getElementById('triviaScore').textContent=0;renderTQ();}
function renderTQ(){const q=TQS[tIdx];document.getElementById('triviaQ').textContent=(tIdx+1)+'/4';document.getElementById('triviaQuestion').textContent=q.q;document.getElementById('triviaFeedback').textContent='';document.getElementById('triviaDots').innerHTML=TQS.map((_,i)=>`<div style="flex:1;height:4px;background:${i<tIdx?'var(--gold)':'var(--border)'};border-radius:2px;margin:0 2px;"></div>`).join('');document.getElementById('triviaOpts').innerHTML=q.opts.map((o,i)=>`<div class="trivia-opt" onclick="answerT(${i})">${o}</div>`).join('');tAnswered=false;}
function answerT(idx){if(tAnswered)return;tAnswered=true;const q=TQS[tIdx];document.querySelectorAll('#gov-trivia .trivia-opt').forEach(o=>o.style.pointerEvents='none');const opts=document.querySelectorAll('#gov-trivia .trivia-opt');if(idx===q.a){opts[idx].style.background='rgba(0,230,118,0.15)';opts[idx].style.borderColor='var(--green)';opts[idx].style.color='var(--green)';tScore+=25;document.getElementById('triviaScore').textContent=tScore;document.getElementById('triviaFeedback').innerHTML='<span style="color:var(--green)">âœ… Â¡Correcto! +25 pts</span>';}else{opts[idx].style.background='rgba(255,61,61,0.15)';opts[idx].style.borderColor='#FF3D3D';opts[idx].style.color='#FF3D3D';opts[q.a].style.background='rgba(0,230,118,0.15)';opts[q.a].style.borderColor='var(--green)';opts[q.a].style.color='var(--green)';document.getElementById('triviaFeedback').innerHTML='<span style="color:#FF3D3D">âŒ Incorrecto</span>';}setTimeout(()=>{tIdx++;if(tIdx<TQS.length)renderTQ();else showGameResult('trivia',tScore,'ğŸ§ ');},1200);}

// â”€â”€ RULETA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ROPTS=[{l:'10',p:10,c:'#1A2030'},{l:'50',p:50,c:'#5A3800'},{l:'25',p:25,c:'#1A3020'},{l:'100',p:100,c:'#1A1A40'},{l:'75',p:75,c:'#2A1A00'},{l:'200',p:200,c:'#5A0000'},{l:'150',p:150,c:'#0A2A20'},{l:'300',p:300,c:'#3A2800'},{l:'30',p:30,c:'#1A2030'},{l:'5',p:5,c:'#2A1020'}];
let rAngle=0,rSpinning=false;
function initRuleta(){rSpinning=false;const sb=document.getElementById('spinBtn');if(sb)sb.disabled=false;const rr=document.getElementById('ruletaResult');if(rr)rr.textContent='Â¡Gira!';drawR(0);}
function drawR(angle){const cv=document.getElementById('ruletaCanvas');if(!cv)return;const ctx=cv.getContext('2d'),cx=cv.width/2,cy=cv.height/2,r=cx-10,arc=(2*Math.PI)/ROPTS.length;ctx.clearRect(0,0,cv.width,cv.height);ROPTS.forEach((o,i)=>{const s=angle+i*arc,e=s+arc;ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,s,e);ctx.fillStyle=o.c;ctx.fill();ctx.strokeStyle='rgba(212,160,23,0.3)';ctx.lineWidth=1;ctx.stroke();ctx.save();ctx.translate(cx,cy);ctx.rotate(s+arc/2);ctx.fillStyle='#E8EDF5';ctx.font='bold 11px sans-serif';ctx.textAlign='right';ctx.fillText(o.l+' PTS',r-8,4);ctx.restore();});ctx.beginPath();ctx.arc(cx,cy,r,0,2*Math.PI);ctx.strokeStyle='rgba(212,160,23,0.5)';ctx.lineWidth=3;ctx.stroke();}
function girarRuleta(){if(rSpinning)return;rSpinning=true;const sb=document.getElementById('spinBtn');if(sb)sb.disabled=true;const rr=document.getElementById('ruletaResult');if(rr)rr.textContent='...';const extra=Math.random()*360,total=(5+Math.floor(Math.random()*3))*360+extra,dur=4000,start=performance.now(),sa=rAngle;function anim(now){const p=Math.min((now-start)/dur,1),ease=1-Math.pow(1-p,3);rAngle=sa+(total*Math.PI/180)*ease;drawR(rAngle);if(p<1){requestAnimationFrame(anim);return;}const arc=(2*Math.PI)/ROPTS.length,norm=((rAngle%(2*Math.PI))+2*Math.PI)%(2*Math.PI),idx=Math.floor(((2*Math.PI-norm)/arc)%ROPTS.length),winner=ROPTS[idx];if(rr)rr.innerHTML='<span style="color:#F0C040">ğŸ‰ '+winner.l+' PTS</span>';setTimeout(()=>showGameResult('ruleta',winner.p,'ğŸ°'),800);}requestAnimationFrame(anim);}

// â”€â”€ CHANGAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CIMG='https://res.cloudinary.com/dfmqybaac/image/upload/v1772308696/alsvin-web-1700x830-exterior-5_dz0dkv.jpg';
let cPieces=[],cSel=null,cMoves=0,cSolved=false;
function initChangan(){cMoves=0;cSolved=false;cSel=null;document.getElementById('changanMoves').textContent=0;document.getElementById('changanTimer').textContent=120;clearInterval(window['gi_changan']);cPieces=Array.from({length:16},(_,i)=>i);for(let i=15;i>0;i--){const j=Math.floor(Math.random()*(i+1));[cPieces[i],cPieces[j]]=[cPieces[j],cPieces[i]];}renderChangan();let t=120;window['gi_changan']=setInterval(()=>{t--;document.getElementById('changanTimer').textContent=t;if(t<=0){clearInterval(window['gi_changan']);if(!cSolved)showGameResult('changan',0,'ğŸ˜…');}},1000);}
function renderChangan(){const b=document.getElementById('changanBoard');if(!b)return;b.innerHTML=cPieces.map((orig,pos)=>{const oc=orig%4,or=Math.floor(orig/4),sel=cSel===pos,cor=orig===pos;return `<div onclick="selChangan(${pos})" style="aspect-ratio:1;background-image:url('${CIMG}');background-size:400% 400%;background-position:${-oc*100}% ${-or*100}%;border:2px solid ${sel?'#D4A017':cor?'rgba(0,230,118,0.5)':'rgba(212,160,23,0.15)'};cursor:pointer;transform:${sel?'scale(1.05)':'scale(1)'};transition:all 0.15s;"></div>`;}).join('');}
function selChangan(pos){if(cSolved)return;tg?.HapticFeedback?.impactOccurred('light');if(cSel===null){cSel=pos;renderChangan();}else if(cSel===pos){cSel=null;renderChangan();}else{[cPieces[cSel],cPieces[pos]]=[cPieces[pos],cPieces[cSel]];cMoves++;document.getElementById('changanMoves').textContent=cMoves;cSel=null;renderChangan();if(cPieces.every((v,i)=>v===i)){cSolved=true;clearInterval(window['gi_changan']);setTimeout(()=>showGameResult('changan',10,'ğŸš—'),400);}}}

// â”€â”€ TETRIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TCOLS=10,TROWS=20,TB=22;
const TPIECES=[[[1,1,1,1]],[[1,1],[1,1]],[[0,1,0],[1,1,1]],[[1,0,0],[1,1,1]],[[0,0,1],[1,1,1]],[[0,1,1],[1,1,0]],[[1,1,0],[0,1,1]]];
const TCLRS=['#00E5FF','#FFD600','#AA00FF','#FF6D00','#1A6EFF','#00E676','#FF3D3D'];
let tBoard,tCur,tX,tY,tColor,tLines=0,tOver=false;
function initTetris(){const cv=document.getElementById('tetrisCanvas');if(!cv)return;cv.width=TCOLS*TB;cv.height=TROWS*TB;tBoard=Array.from({length:TROWS},()=>Array(TCOLS).fill(null));tLines=0;tOver=false;document.getElementById('tetrisLines').textContent='0/6';tSpawn();if(window.tetrisLoop)clearInterval(window.tetrisLoop);window.tetrisLoop=setInterval(tTick,600);drawTetris();}
function tSpawn(){const i=Math.floor(Math.random()*TPIECES.length);tCur=TPIECES[i];tColor=TCLRS[i];tX=Math.floor((TCOLS-tCur[0].length)/2);tY=0;if(!tCan(tX,tY,tCur)){tOver=true;tEnd();}}
function tCan(x,y,p){return p.every((row,dy)=>row.every((v,dx)=>{if(!v)return true;const nx=x+dx,ny=y+dy;return nx>=0&&nx<TCOLS&&ny>=0&&ny<TROWS&&!tBoard[ny][nx];}));}
function tPlace(){tCur.forEach((row,dy)=>row.forEach((v,dx)=>{if(v)tBoard[tY+dy][tX+dx]=tColor;}));let cl=0;for(let r=TROWS-1;r>=0;r--){if(tBoard[r].every(c=>c)){tBoard.splice(r,1);tBoard.unshift(Array(TCOLS).fill(null));cl++;r++;}}if(cl>0){tLines+=cl;document.getElementById('tetrisLines').textContent=tLines+'/6';if(tLines>=6){clearInterval(window.tetrisLoop);window.tetrisLoop=null;showGameResult('tetris',500,'ğŸ’');return;}}tSpawn();}
function tTick(){if(tOver)return;if(tCan(tX,tY+1,tCur))tY++;else tPlace();drawTetris();}
function tetrisMove(d){if(tOver)return;if(tCan(tX+d,tY,tCur)){tX+=d;drawTetris();}}
function tetrisRotate(){if(tOver)return;const r=tCur[0].map((_,i)=>tCur.map(row=>row[i]).reverse());if(tCan(tX,tY,r)){tCur=r;drawTetris();}}
function tetrisDrop(){if(tOver)return;while(tCan(tX,tY+1,tCur))tY++;tPlace();drawTetris();}
function tEnd(){clearInterval(window.tetrisLoop);window.tetrisLoop=null;if(tLines===0){toast('ğŸ’€ Game Over');cerrarJuego('tetris');return;}showGameResult('tetris',Math.min(tLines*80,480),tLines>=6?'ğŸ’':'ğŸ®');}
function drawTetris(){const cv=document.getElementById('tetrisCanvas');if(!cv)return;const ctx=cv.getContext('2d');ctx.fillStyle='#07090C';ctx.fillRect(0,0,cv.width,cv.height);tBoard.forEach((row,r)=>row.forEach((col,c)=>{if(col){ctx.fillStyle=col;ctx.fillRect(c*TB+1,r*TB+1,TB-2,TB-2);}}));if(tCur)tCur.forEach((row,dy)=>row.forEach((v,dx)=>{if(v){ctx.fillStyle=tColor;ctx.fillRect((tX+dx)*TB+1,(tY+dy)*TB+1,TB-2,TB-2);}}));}

setTimeout(()=>{loadGameState();},2000);
</script>
</body>
</html>
