<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Karla PPP ‚Äî Panel de Env√≠os</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --red: #CC0000;
    --red2: #E53935;
    --dark: #F5F5F5;
    --dark2: #FFFFFF;
    --dark3: #FAFAFA;
    --border: #E0E0E0;
    --text: #1A1A1A;
    --muted: #757575;
    --green: #2E7D32;
    --yellow: #F57F17;
    --blue: #1565C0;
  }

  * { margin:0; padding:0; box-sizing:border-box; }
  
  body {
    background: var(--dark);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    background: #CC0000;
    border-bottom: 1px solid #AA0000;
    padding: 0 32px;
    display: flex; align-items: center; justify-content: space-between;
    height: 60px;
    position: sticky; top: 0; z-index: 100;
  }
  .logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 24px; letter-spacing: 5px;
    color: #FFFFFF;
  }
  .logo span { color: var(--text); }
  .header-right { display:flex; align-items:center; gap:20px; }
  .status-pill {
    display: flex; align-items: center; gap: 8px;
    padding: 5px 14px;
    border: 1px solid rgba(255,255,255,0.3);
    font-size: 12px; letter-spacing: 2px;
    color: rgba(255,255,255,0.8);
  }
  .status-dot { width:8px; height:8px; border-radius:50%; background:var(--muted); }
  .status-dot.active { background:var(--green); animation: blink 1s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
  
  .btn-logout {
    background: none; border: 1px solid #2A0000;
    color: white; border-color: rgba(255,255,255,0.4); padding: 6px 16px;
    font-family: 'Rajdhani', sans-serif;
    font-size: 13px; letter-spacing: 2px;
    cursor: pointer; transition: background 0.2s;
  }
  .btn-logout:hover { background: rgba(204,0,0,0.1); }

  /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
  .container {
    max-width: 1300px; margin: 0 auto;
    padding: 32px 24px;
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
  }

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .card {
    background: var(--dark2);
    border: 1px solid var(--border);
    margin-bottom: 20px;
  }
  .card-header {
    padding: 16px 24px;
    border-bottom: 1px solid var(--border); background: #CC0000;
    display: flex; align-items: center; gap: 12px;
  }
  .card-num {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px; color: rgba(255,255,255,0.5);
    opacity: 1; line-height: 1;
  }
  .card-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px; letter-spacing: 2px; color: white;
  }
  .card-body { padding: 24px; }

  /* ‚îÄ‚îÄ UPLOAD ZONE ‚îÄ‚îÄ */
  .upload-zone {
    border: 2px dashed var(--border);
    padding: 40px 24px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    position: relative;
  }
  .upload-zone:hover, .upload-zone.dragover {
    border-color: var(--red);
    background: rgba(204,0,0,0.06);
  }
  .upload-zone input { position:absolute; inset:0; opacity:0; cursor:pointer; }
  .upload-icon { font-size: 40px; margin-bottom: 12px; }
  .upload-text { font-size: 16px; color: var(--muted); letter-spacing: 1px; }
  .upload-types { font-size: 12px; color: var(--muted); margin-top: 6px; letter-spacing: 1px; }

  .file-preview {
    display: none;
    margin-top: 16px;
    padding: 14px 16px;
    background: rgba(0,200,83,0.06);
    border: 1px solid rgba(0,200,83,0.2);
    display: none; align-items: center; gap: 12px;
  }
  .file-preview.show { display: flex; }
  .file-info { flex: 1; }
  .file-name { font-size: 14px; font-weight: 600; }
  .file-size { font-size: 12px; color: var(--muted); }
  .file-remove {
    background: none; border: none; color: var(--muted);
    cursor: pointer; font-size: 18px; padding: 4px;
  }
  .file-remove:hover { color: var(--red2); }

  .upload-progress {
    display: none;
    margin-top: 12px;
    height: 3px;
    background: var(--border);
    overflow: hidden;
  }
  .upload-progress.show { display: block; }
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--red), var(--red2));
    width: 0%;
    transition: width 0.3s;
    animation: progressAnim 1.5s ease-in-out infinite;
  }
  @keyframes progressAnim {
    0%{width:0%} 50%{width:70%} 100%{width:100%}
  }

  .drive-url {
    display: none;
    margin-top: 12px;
    padding: 10px 14px;
    background: var(--dark3);
    border: 1px solid var(--border);
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: var(--blue);
    word-break: break-all;
  }
  .drive-url.show { display: block; }

  /* ‚îÄ‚îÄ TEXTAREA ‚îÄ‚îÄ */
  .msg-area {
    width: 100%;
    background: var(--dark3);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 16px;
    font-family: 'Rajdhani', sans-serif;
    font-size: 16px;
    min-height: 140px;
    resize: vertical;
    outline: none;
    transition: border-color 0.2s;
    letter-spacing: 0.3px;
  }
  .msg-area:focus { border-color: var(--red); }
  .msg-hint {
    font-size: 12px; color: var(--muted);
    margin-top: 8px; letter-spacing: 1px;
  }

  /* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
  input[type="text"] {
    width: 100%;
    background: var(--dark3);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 14px;
    font-family: 'Rajdhani', sans-serif;
    font-size: 15px;
    outline: none;
    transition: border-color 0.2s;
  }
  input[type="text"]:focus { border-color: var(--red); }

  label {
    display: block;
    font-size: 11px; letter-spacing: 3px;
    color: var(--muted); margin-bottom: 8px;
    text-transform: uppercase;
  }

  /* ‚îÄ‚îÄ BOTONES ‚îÄ‚îÄ */
  .btn {
    padding: 14px 28px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px; letter-spacing: 3px;
    border: none; cursor: pointer;
    transition: all 0.2s;
    display: inline-flex; align-items: center; gap: 10px;
  }
  .btn-primary {
    background: var(--red);
    color: white;
    width: 100%;
    justify-content: center;
    font-size: 22px;
    padding: 18px;
  }
  .btn-primary:hover { background: #AA0000; transform: translateY(-1px); }
  .btn-primary:disabled { background: #2A0000; color: #555; cursor: not-allowed; transform: none; }
  
  .btn-stop {
    background: none;
    border: 1px solid var(--red);
    color: var(--red);
    width: 100%;
    justify-content: center;
    margin-top: 10px;
    display: none;
  }
  .btn-stop.show { display: inline-flex; }
  .btn-stop:hover { background: rgba(204,0,0,0.1); }

  .btn-sm {
    padding: 8px 16px; font-size: 14px;
    background: var(--dark3);
    border: 1px solid var(--border);
    color: var(--text);
  }
  .btn-sm:hover { border-color: var(--red); color: var(--red); }

  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  .sidebar { }

  /* Stats */
  .stats-grid {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 1px; background: var(--border);
    margin-bottom: 20px;
  }
  .stat {
    background: #FFFFFF;
    padding: 20px 16px; text-align: center; border: 1px solid #E0E0E0;
  }
  .stat-num {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 42px; line-height: 1;
  }
  .stat-num.green { color: var(--green); }
  .stat-num.red   { color: var(--red2); }
  .stat-num.blue  { color: var(--blue); }
  .stat-num.yellow{ color: var(--yellow); }
  .stat-label { font-size: 11px; letter-spacing: 2px; color: var(--muted); margin-top: 4px; }

  /* Progreso */
  .progress-ring {
    text-align: center; padding: 20px;
  }
  .progress-text {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 48px; color: var(--text);
  }
  .progress-sub { font-size: 12px; color: var(--muted); letter-spacing: 2px; }
  .progress-outer {
    height: 4px; background: var(--border);
    margin: 16px 0; overflow: hidden;
  }
  .progress-inner {
    height: 100%;
    background: linear-gradient(90deg, var(--red), var(--red2));
    width: 0%;
    transition: width 0.5s;
  }

  .current-send {
    padding: 10px 14px;
    background: var(--dark3);
    border-left: 2px solid var(--yellow);
    font-size: 13px; color: var(--yellow);
    margin-bottom: 16px;
    min-height: 40px;
    font-family: 'JetBrains Mono', monospace;
    display: none;
  }
  .current-send.show { display: block; }

  /* LOG */
  .log-box {
    background: #F9F9F9;
    border: 1px solid var(--border);
    height: 280px;
    overflow-y: auto;
    padding: 12px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
  }
  .log-box::-webkit-scrollbar { width: 4px; }
  .log-box::-webkit-scrollbar-track { background: var(--dark2); }
  .log-box::-webkit-scrollbar-thumb { background: var(--border); }

  .log-line { padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
  .log-line.ok   { color: var(--green); }
  .log-line.err  { color: var(--red2); }
  .log-line.info { color: #9E9E9E; }
  .log-line.warn { color: var(--yellow); }
  .log-ts { color: #BDBDBD; margin-right: 8px; }

  /* Contactos */
  .contactos-count {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 52px; color: var(--text); line-height: 1;
  }
  .contactos-label { font-size: 12px; letter-spacing: 3px; color: var(--muted); }

  .contactos-list {
    max-height: 180px; overflow-y: auto;
    margin-top: 12px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
  }
  .contacto-item {
    padding: 5px 8px;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    display: flex; justify-content: space-between;
    color: var(--muted);
  }
  .contacto-item:hover { background: #FFF3F3; color: var(--red); }

  /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
  @media (max-width: 900px) {
    .container { grid-template-columns: 1fr; }
  }
  @media (max-width: 600px) {
    header { padding: 0 16px; }
    .container { padding: 16px; }
    .card-body { padding: 16px; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">KARLA <span>PPP</span> ‚Äî PANEL</div>
  <div class="header-right">
    <div class="status-pill">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">INACTIVO</span>
    </div>
    <button class="btn-logout" onclick="location.href='/logout'">SALIR</button>
  </div>
</header>

<!-- MAIN -->
<div class="container">

  <!-- COLUMNA IZQUIERDA -->
  <div class="main-col">

    <!-- PASO 1: ARCHIVO -->
    <div class="card">
      <div class="card-header">
        <div class="card-num">01</div>
        <div class="card-title">SUBIR IMAGEN / VIDEO / PDF</div>
      </div>
      <div class="card-body">
        <div class="upload-zone" id="uploadZone">
          <input type="file" id="fileInput" accept="image/*,video/mp4,.pdf">
          <div class="upload-icon">üìÅ</div>
          <div class="upload-text">Arrastra o haz clic para seleccionar</div>
          <div class="upload-types">JPG ¬∑ PNG ¬∑ MP4 ¬∑ PDF ‚Äî M√°x. 50MB</div>
        </div>

        <div class="file-preview" id="filePreview">
          <span id="fileIcon" style="font-size:24px">üìÑ</span>
          <div class="file-info">
            <div class="file-name" id="fileName">‚Äî</div>
            <div class="file-size" id="fileSize">‚Äî</div>
          </div>
          <button class="file-remove" onclick="clearFile()">‚úï</button>
        </div>

        <div class="upload-progress" id="uploadProgress">
          <div class="progress-bar"></div>
        </div>

        <div class="drive-url" id="driveUrl"></div>
      </div>
    </div>

    <!-- PASO 2: MENSAJE -->
    <div class="card">
      <div class="card-header">
        <div class="card-num">02</div>
        <div class="card-title">NOTA DE PRENSA / MENSAJE</div>
      </div>
      <div class="card-body">
        <textarea class="msg-area" id="mensaje" placeholder="Escribe aqu√≠ tu mensaje o nota de prensa...&#10;&#10;Tip: Usa {nombre} para personalizar con el nombre del contacto."></textarea>
        <div class="msg-hint">üí° Usa <strong>{nombre}</strong> para personalizar ‚Äî ej: "Hola {nombre}, te compartimos..."</div>
      </div>
    </div>

    <!-- PASO 3: CONTACTOS -->
    <div class="card">
      <div class="card-header">
        <div class="card-num">03</div>
        <div class="card-title">LISTA DE CONTACTOS</div>
      </div>
      <div class="card-body">
        <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
          <button class="btn btn-sm" onclick="cargarContactos()">üîÑ CARGAR DESDE SHEETS</button>
          <span style="font-size:13px; color:var(--muted);" id="sheetStatus">No cargado</span>
        </div>

        <div style="display:flex; align-items:baseline; gap:16px; margin-bottom:12px;">
          <div class="contactos-count" id="contactosCount">0</div>
          <div class="contactos-label">CONTACTOS LISTOS</div>
        </div>

        <div class="contactos-list" id="contactosList"></div>
      </div>
    </div>

    <!-- PASO 4: ENVIAR -->
    <div class="card">
      <div class="card-header">
        <div class="card-num">04</div>
        <div class="card-title">PROGRAMAR ENV√çO</div>
      </div>
      <div class="card-body">
        <div style="padding:12px 16px; background:rgba(255,179,0,0.06); border:1px solid rgba(255,179,0,0.2); margin-bottom:20px;">
          <div style="font-size:13px; color:var(--yellow); margin-bottom:4px;">‚è±Ô∏è DELAY ANTI-BLOQUEO ACTIVO</div>
          <div style="font-size:12px; color:var(--muted);">Env√≠o con retraso aleatorio de 15-30 segundos entre cada mensaje para proteger el n√∫mero.</div>
        </div>
        <button class="btn btn-primary" id="btnEnviar" onclick="iniciarEnvio()">
          üöÄ INICIAR ENV√çO MASIVO
        </button>
        <button class="btn btn-stop" id="btnDetener" onclick="detenerEnvio()">
          ‚õî DETENER ENV√çO
        </button>
      </div>
    </div>

  </div>

  <!-- SIDEBAR DERECHO -->
  <div class="sidebar">

    <!-- STATS -->
    <div class="stats-grid">
      <div class="stat">
        <div class="stat-num blue" id="statTotal">0</div>
        <div class="stat-label">TOTAL</div>
      </div>
      <div class="stat">
        <div class="stat-num green" id="statEnviados">0</div>
        <div class="stat-label">ENVIADOS</div>
      </div>
      <div class="stat">
        <div class="stat-num red" id="statErrores">0</div>
        <div class="stat-label">ERRORES</div>
      </div>
      <div class="stat">
        <div class="stat-num yellow" id="statRestantes">0</div>
        <div class="stat-label">RESTANTES</div>
      </div>
    </div>

    <!-- PROGRESO -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">PROGRESO</div>
      </div>
      <div class="card-body" style="padding:16px;">
        <div class="progress-ring">
          <div class="progress-text" id="progressPct">0%</div>
          <div class="progress-sub">COMPLETADO</div>
        </div>
        <div class="progress-outer">
          <div class="progress-inner" id="progressBar"></div>
        </div>
        <div class="current-send" id="currentSend">‚Äî</div>
      </div>
    </div>

    <!-- LOG -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">LOG EN TIEMPO REAL</div>
        <button class="btn btn-sm" style="margin-left:auto; padding:4px 10px; font-size:12px;" onclick="document.getElementById('logBox').innerHTML=''">LIMPIAR</button>
      </div>
      <div class="log-box" id="logBox">
        <div class="log-line info"><span class="log-ts">--:--:--</span> Panel iniciado. Listo para enviar.</div>
      </div>
    </div>

  </div>
</div>

<script>
// ‚îÄ‚îÄ ESTADO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let contactos    = [];
let archivoData  = null;  // { url, tipo }
let pollingTimer = null;

// ‚îÄ‚îÄ UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fileInput  = document.getElementById('fileInput');
const uploadZone = document.getElementById('uploadZone');

uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault();
  uploadZone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) subirArchivo(file);
});

fileInput.addEventListener('change', () => {
  if (fileInput.files[0]) subirArchivo(fileInput.files[0]);
});

async function subirArchivo(file) {
  const preview = document.getElementById('filePreview');
  const progress = document.getElementById('uploadProgress');
  const driveUrl = document.getElementById('driveUrl');

  // Mostrar preview
  document.getElementById('fileName').textContent = file.name;
  document.getElementById('fileSize').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
  document.getElementById('fileIcon').textContent = file.type.startsWith('image') ? 'üñºÔ∏è' : file.type.includes('video') ? 'üé¨' : 'üìÑ';
  preview.classList.add('show');
  progress.classList.add('show');
  driveUrl.classList.remove('show');

  const formData = new FormData();
  formData.append('archivo', file);

  try {
    const resp = await fetch('/api/upload', { method: 'POST', body: formData });
    const data = await resp.json();

    progress.classList.remove('show');

    if (data.ok) {
      archivoData = { url: data.url, tipo: data.tipo };
      driveUrl.textContent = '‚úÖ Drive: ' + data.url;
      driveUrl.classList.add('show');
      addLog('ok', `üìÅ Archivo subido a Drive: ${data.nombre}`);
    } else {
      addLog('err', '‚ùå Error subiendo archivo: ' + data.error);
    }
  } catch(e) {
    progress.classList.remove('show');
    addLog('err', '‚ùå Error de conexi√≥n: ' + e.message);
  }
}

function clearFile() {
  archivoData = null;
  fileInput.value = '';
  document.getElementById('filePreview').classList.remove('show');
  document.getElementById('driveUrl').classList.remove('show');
  document.getElementById('uploadProgress').classList.remove('show');
}

// ‚îÄ‚îÄ CONTACTOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function cargarContactos() {
  document.getElementById('sheetStatus').textContent = '‚è≥ Cargando...';
  try {
    const resp = await fetch('/api/contactos');
    const data = await resp.json();

    if (data.ok) {
      contactos = data.contactos;
      document.getElementById('contactosCount').textContent = contactos.length;
      document.getElementById('statTotal').textContent = contactos.length;
      document.getElementById('sheetStatus').textContent = `‚úÖ ${contactos.length} contactos cargados`;

      const list = document.getElementById('contactosList');
      list.innerHTML = contactos.slice(0, 100).map(c =>
        `<div class="contacto-item"><span>${c.nombre}</span><span>${c.numero}</span></div>`
      ).join('') + (contactos.length > 100 ? `<div class="contacto-item info">... y ${contactos.length - 100} m√°s</div>` : '');

      addLog('ok', `üìã ${contactos.length} contactos cargados desde Sheets`);
    } else {
      document.getElementById('sheetStatus').textContent = '‚ùå Error: ' + data.error;
      addLog('err', 'Error cargando contactos: ' + data.error);
    }
  } catch(e) {
    document.getElementById('sheetStatus').textContent = '‚ùå Error de conexi√≥n';
    addLog('err', 'Error: ' + e.message);
  }
}

// ‚îÄ‚îÄ ENV√çO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function iniciarEnvio() {
  const mensaje = document.getElementById('mensaje').value.trim();

  if (!mensaje && !archivoData) {
    alert('Escribe un mensaje o sube un archivo primero.');
    return;
  }
  if (contactos.length === 0) {
    alert('Carga los contactos desde Sheets primero.');
    return;
  }

  const confirm = window.confirm(`¬øIniciar env√≠o a ${contactos.length} contactos?\n\nDelay: 15-30 segundos entre env√≠os.\nTiempo estimado: ~${Math.round(contactos.length * 22.5 / 60)} minutos.`);
  if (!confirm) return;

  try {
    const resp = await fetch('/api/enviar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        mensaje,
        mediaUrl:  archivoData?.url  || null,
        mediaType: archivoData?.tipo || null,
        contactos
      })
    });
    const data = await resp.json();
    if (data.ok) {
      setEnvioActivo(true);
      iniciarPolling();
      addLog('ok', `üöÄ Env√≠o iniciado ‚Äî ${data.total} contactos`);
    } else {
      addLog('err', '‚ùå ' + data.error);
    }
  } catch(e) {
    addLog('err', '‚ùå Error: ' + e.message);
  }
}

async function detenerEnvio() {
  await fetch('/api/detener', { method: 'POST' });
  setEnvioActivo(false);
  if (pollingTimer) clearInterval(pollingTimer);
}

// ‚îÄ‚îÄ POLLING DE ESTADO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lastLogLen = 0;

function iniciarPolling() {
  if (pollingTimer) clearInterval(pollingTimer);
  pollingTimer = setInterval(actualizarEstado, 2000);
}

async function actualizarEstado() {
  try {
    const resp = await fetch('/api/estado');
    const data = await resp.json();

    const s = data.stats;
    document.getElementById('statEnviados').textContent  = s.enviados;
    document.getElementById('statErrores').textContent   = s.errores;
    document.getElementById('statRestantes').textContent = Math.max(0, s.total - s.enviados - s.errores);

    const pct = s.total > 0 ? Math.round((s.enviados + s.errores) / s.total * 100) : 0;
    document.getElementById('progressPct').textContent = pct + '%';
    document.getElementById('progressBar').style.width  = pct + '%';

    const currentEl = document.getElementById('currentSend');
    if (s.actual) {
      currentEl.textContent = 'üì§ ' + s.actual;
      currentEl.classList.add('show');
    } else {
      currentEl.classList.remove('show');
    }

    // Nuevos logs
    const newLogs = data.log.slice(lastLogLen);
    newLogs.forEach(l => addLog(l.tipo, l.msg, l.ts));
    lastLogLen = data.log.length;

    if (!data.activo) {
      setEnvioActivo(false);
      clearInterval(pollingTimer);
    }
  } catch(e) {}
}

// ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setEnvioActivo(activo) {
  const dot  = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  const btnE = document.getElementById('btnEnviar');
  const btnD = document.getElementById('btnDetener');

  dot.className  = 'status-dot' + (activo ? ' active' : '');
  text.textContent = activo ? 'ENVIANDO...' : 'INACTIVO';
  btnE.disabled  = activo;
  btnD.className = 'btn btn-stop' + (activo ? ' show' : '');
}

function addLog(tipo, msg, ts) {
  const box = document.getElementById('logBox');
  const time = ts || new Date().toLocaleTimeString('es-PE');
  const div  = document.createElement('div');
  div.className = `log-line ${tipo}`;
  div.innerHTML = `<span class="log-ts">${time}</span>${msg}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}
</script>
</body>
</html>
